{% extends "base_auth.html" %}
{% load static %}

{% block title %}Funcion치rios{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css" />
<style>
  :root {
    --primary: #0069d9;  /* Azul mais leve, opcional */
    --light-bg: #f8f9fa;
    --card-bg: #ffffff;
    --border: #dee2e6;
    --text: #212529;
  }

  body {
    background: var(--light-bg);
    color: var(--text);
  }

  .form-container {
    max-width: 100%;
  }

  .card {
    border: 1px solid var(--border);
    border-radius: .5rem;
    background-color: var(--card-bg);
  }

  .card-header {
    background-color: var(--primary);
    color: white;
    font-weight: bold;
    border-bottom: none;
    border-radius: .5rem .5rem 0 0;
  }

    .nav-tabs .nav-link {
    border: 1px solid var(--border);
    background-color: var(--card-bg);
    color: var(--text);
    }

    .nav-tabs .nav-link.active {
    background-color: var(--card-bg);
    border-color: var(--primary) var(--primary) var(--card-bg);
    color: var(--primary);
    font-weight: normal;  /* Removendo o negrito */
    }

    .register-button {
    border-radius: 0.2rem;  /* Mais quadrado */
    border: 1px solid var(--primary);  /* Borda sutil */
    background-color: var(--primary);
    color: white;
    font-weight: normal; /* Tira o negrito se quiser */
    padding: 0.75rem;
    width: 100%;
    }

  .register-button:hover {
    background-color: #0056b3;
  }

  .ag-theme-quartz {
    height: 500px;
    width: 100%;
    margin-top: 1rem;
    border-radius: 10px;
  }

  .toast-password {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1055;
  }

  .ag-cell input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="form-container mx-auto">
    <div class="card shadow-sm">
      {% comment %} <div class="card-header">
        <i class="fa-solid fa-users me-2"></i>Gerenciar Funcion치rios
      </div> {% endcomment %}
      <div class="card-body">
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item">
            <button class="nav-link active" data-coreui-toggle="tab" data-coreui-target="#cadastro">游닇 Cadastrar Funcion치rio</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-coreui-toggle="tab" data-coreui-target="#listagem">游늶 Listar Funcion치rios</button>
          </li>
        </ul>

        <div class="tab-content">

          <!-- Cadastro -->
          <div class="tab-pane fade show active" id="cadastro">
            <div id="register-error" class="alert alert-danger d-none"></div>
            <form id="register-form" method="post" class="row g-3">
              {% csrf_token %}
              <div class="col-md-6">
                <label class="form-label">Nome Completo</label>
                <input type="text" name="name" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">CPF (Login)</label>
                <input type="text" name="cpf" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Telefone</label>
                <input type="text" name="phone" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Cargo</label>
                <select name="role" class="form-select" required>
                  <option value="">Selecione um cargo</option>
                  <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                  <option value="RECEP칂츾O">RECEP칂츾O</option>
                  <option value="ATENDENTE">ATENDENTE</option>
                </select>
              </div>
              <div class="col-12">
                <button type="submit" class="register-button">Registrar Funcion치rio</button>
              </div>
            </form>
          </div>

          <!-- Listagem -->
          <div class="tab-pane fade" id="listagem">
            <div id="employeeGrid" class="ag-theme-quartz"></div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast para senha -->
<div id="password-toast" class="toast align-items-center toast-password bg-dark text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="d-flex">
    <div class="toast-body">
      Senha de acesso gerada: <strong id="generated-password"></strong>
    </div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.3/dist/ag-grid-community.min.noStyle.js"></script>
<script>
  const gridOptions = {
    columnDefs: [
      { headerName: "ID", field: "id", maxWidth: 90 },
      { headerName: "Nome", field: "name" },
      { headerName: "CPF", field: "cpf" },
      { headerName: "Email", field: "email" },
      { headerName: "Telefone", field: "phone" },
      { headerName: "Cargo", field: "role" },
      {
        headerName: "Ativo", field: "active", maxWidth: 110,
        cellRenderer: params => {
          const checked = params.value ? "checked" : "";
          return `<input type="checkbox" class="employee-toggle" data-id="${params.data.id}" ${checked}>`;
        }
      }
    ],
    rowData: [],
    pagination: true,
    paginationPageSize: 10,
    defaultColDef: {
      sortable: true,
      filter: true,
      resizable: true,
      flex: 1
    },
    onFirstDataRendered: attachToggleEvents,
    onCellClicked: attachToggleEvents
  };

  function attachToggleEvents() {
    // Remove eventos anteriores para evitar m칰ltiplos binds
    document.querySelectorAll('.employee-toggle').forEach(chk => {
      const clone = chk.cloneNode(true);
      chk.parentNode.replaceChild(clone, chk);
    });

    // Reatribuir eventos
    document.querySelectorAll('.employee-toggle').forEach(chk => {
      chk.addEventListener('change', async () => {
        const id = chk.dataset.id;
        const status = chk.checked;

        try {
          const res = await fetch("{% url 'toggle_employee_status' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({
              person_id: id,
              active: status
            })
          });

          const json = await res.json();
          if (!json.success) {
            alert("Erro ao atualizar status.");
            chk.checked = !status;
          }
        } catch (err) {
          alert("Erro de conex칚o.");
          chk.checked = !status;
        }
      });
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      document.cookie.split(";").forEach(c => {
        c = c.trim();
        if (c.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(c.substring(name.length + 1));
        }
      });
    }
    return cookieValue;
  }

  async function loadEmployees() {
    try {
      const res = await fetch("{% url 'list_employees' %}");
      const data = await res.json();
      if (gridOptions.api) {
        gridOptions.api.setRowData(data);
      }
    } catch (err) {
      alert("Erro ao carregar funcion치rios.");
    }
  }

  function showPasswordToast(password) {
    const toastElement = document.getElementById('password-toast');
    document.getElementById('generated-password').textContent = password;
    const toast = new bootstrap.Toast(toastElement, { delay: 10000 });
    toast.show();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const gridDiv = document.querySelector('#employeeGrid');
    if (gridDiv) {
      new agGrid.Grid(gridDiv, gridOptions);
      loadEmployees();
    }

    const form = document.getElementById('register-form');
    if (form) {
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(form);
        const errorBox = document.getElementById('register-error');
        errorBox.classList.add('d-none');

        try {
          const res = await fetch("{% url 'employees_register' %}", {
            method: "POST",
            headers: { "X-CSRFToken": getCookie("csrftoken") },
            body: formData
          });

          const json = await res.json();

          if (!res.ok || !json.success) {
            let msg = json.errors ? Object.values(json.errors).join("<br>") : "Erro ao registrar.";
            errorBox.innerHTML = msg;
            errorBox.classList.remove('d-none');
            return;
          }

          form.reset();
          loadEmployees();
          document.querySelector('button[data-coreui-target="#listagem"]').click();

          if (json.password) {
            showPasswordToast(json.password);
          }

        } catch (err) {
          errorBox.textContent = "Erro de conex칚o.";
          errorBox.classList.remove('d-none');
        }
      });
    }
  });
</script>
{% endblock %}
