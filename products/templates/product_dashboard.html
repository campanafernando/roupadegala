{% extends "base_auth.html" %}
{% load static %}

{% block title %}Produtos{% endblock title %}

{% block extra_head %}
  <link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css" rel="stylesheet">
  <style>
    .ag-theme-quartz, .ag-theme-quartz-dark {
      height: 500px;
      margin-top: 1rem;
    }
    body.dark-mode .nav-tabs .nav-link { color: #eee; }
    body:not(.dark-mode) .nav-tabs .nav-link { color: #333; }
  </style>
{% endblock extra_head %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-header bg-transparent border-0 pb-0">
      <ul class="nav nav-tabs" id="produtosTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-coreui-toggle="tab" data-coreui-target="#cadastro" type="button">Cadastrar</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-coreui-toggle="tab" data-coreui-target="#listagem" type="button">Estoque</button>
        </li>
      </ul>
    </div>
    <div class="card-body">
      <div class="tab-content">

        <!-- Cadastro -->
        <div class="tab-pane fade show active" id="cadastro">
          <form method="POST" class="row g-3">
            {% csrf_token %}

            <div class="col-md-4">
              <label class="form-label">Tipo</label>
              <select name="product_type" class="form-select" required>
                {% for pt in product_types %}<option value="{{ pt.id }}">{{ pt.description }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Marca</label>
              <select name="brand" class="form-select" required>
                {% for b in brands %}<option value="{{ b.id }}">{{ b.description }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Tecido</label>
              <select name="fabric" class="form-select" required>
                {% for f in fabrics %}<option value="{{ f.id }}">{{ f.description }}</option>{% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Catálogo de Cores</label>
              <select name="color_catalogue" class="form-select" required>
                {% for c in color_catalogues %}<option value="{{ c.id }}">{{ c.description }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Intensidade da Cor</label>
              <select name="color_intensity" class="form-select" required>
                {% for ci in color_intensities %}<option value="{{ ci.id }}">{{ ci.description }}</option>{% endfor %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Padrão</label>
              <select name="pattern" class="form-select">
                <option value="">—</option>
                {% for p in patterns %}<option value="{{ p.id }}">{{ p.description }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Botão</label>
              <select name="button" class="form-select">
                <option value="">—</option>
                {% for b in buttons %}<option value="{{ b.id }}">{{ b.description }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Lapela</label>
              <select name="lapel" class="form-select">
                <option value="">—</option>
                {% for l in lapels %}<option value="{{ l.id }}">{{ l.description }}</option>{% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Modelo</label>
              <select name="model" class="form-select">
                <option value="">—</option>
                {% for m in models %}<option value="{{ m.id }}">{{ m.description }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Estoque</label>
              <select name="on_stock" class="form-select">
                <option value="true">Sim</option>
                <option value="false">Não</option>
              </select>
            </div>

            <div class="col-12">
              <button type="submit" class="btn btn-primary">Salvar Produto</button>
            </div>
          </form>
        </div>

        <!-- Listagem -->
        <div class="tab-pane fade" id="listagem">
          <div id="productGrid" class="ag-theme-quartz w-100"></div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Modal de status -->
<div class="modal fade" id="stockModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="updateStockForm" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="product_id" id="modalProductId">
      <div class="modal-header">
        <h5 class="modal-title">Alterar Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="confirmToggleStock" name="on_stock">
          <label class="form-check-label" for="confirmToggleStock">Em estoque</label>
        </div>
        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="confirmToggleCanceled" name="canceled">
          <label class="form-check-label" for="confirmToggleCanceled">Remover produto</label>
        </div>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="generateQRCode" name="generate_qr_code">
          <label class="form-check-label" for="generateQRCode">Gerar QR Code</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Salvar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </form>
  </div>
</div>
{% endblock content %}

{% block extra_scripts %}
<script>
(function(){
  const rowData = {{ products_aggrid_data|safe }};
  const gridOptions = {
    columnDefs: [
      { headerName:'Ações', field:'id', width:80, cellRenderer:p=>`<input type="checkbox" class="toggle-stock" data-id="${p.data.id}">`, sortable:false, filter:false },
      { headerName:'Tipo', field:'product_type' },
      { headerName:'Marca', field:'brand' },
      { headerName:'Tecido', field:'fabric' },
      { headerName:'Cor', field:'color' },
      { headerName:'Modelo', field:'model' },
      { headerName:'Código', field:'label_code' },
      { headerName:'Estoque', field:'on_stock', cellRenderer:p=>p.value?'✔️':'❌' }
    ],
    rowData, pagination:true, paginationPageSize:10,
    defaultColDef:{ sortable:true, filter:true, resizable:true }
  };

  function renderGrid(){
    const gridDiv = document.querySelector('#productGrid');
    gridDiv.className = document.body.classList.contains('dark-mode')
      ? 'ag-theme-quartz-dark w-100'
      : 'ag-theme-quartz w-100';
    agGrid.createGrid(gridDiv, gridOptions);
    setTimeout(()=>{
      document.querySelectorAll('.toggle-stock').forEach(chk=>{
        chk.checked=false;
        chk.onchange=()=>{
          document.getElementById('modalProductId').value = chk.dataset.id;
          new bootstrap.Modal('#stockModal').show();
        };
      });
    },200);
  }

  document.addEventListener('DOMContentLoaded',()=>{
    // restaurar aba
    const tab = localStorage.getItem('activeTab');
    if(tab) document.querySelector(`[data-coreui-target="${tab}"]`).click();
    document.querySelectorAll('[data-coreui-toggle="tab"]').forEach(btn=>{
      btn.onclick=()=>localStorage.setItem('activeTab', btn.getAttribute('data-coreui-target'));
    });

    renderGrid();

    // submit modal
    document.getElementById('updateStockForm').onsubmit = e=>{
      e.preventDefault();
      const id = modalProductId.value;
      const payload = {
        product_id: id,
        on_stock: confirmToggleStock.checked,
        canceled: confirmToggleCanceled.checked
      };
      fetch("{% url 'update_product_stock' %}", {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
        body:JSON.stringify(payload)
      })
      .then(r=>r.json())
      .then(d=>{
        if(d.success){
          bootstrap.Modal.getInstance('#stockModal').hide();
          if(generateQRCode.checked) window.open(`/products/${id}/generate_qr/`, '_blank');
          setTimeout(()=>location.reload(),500);
        } else alert('Erro ao atualizar');
      }).catch(()=>alert('Erro de servidor'));
    };

    // redesenhar no dark toggle
    document.getElementById('darkModeToggle').onclick = ()=>setTimeout(renderGrid,300);
  });
})();
</script>
{% endblock extra_scripts %}
