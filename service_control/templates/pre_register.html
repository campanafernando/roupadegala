{% extends "base_auth.html" %}
{% load static %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
  :root {
    --primary: #0069d9;
    --light-bg: #f8f9fa;
    --card-bg: #ffffff;
    --border: #dee2e6;
    --text: #212529;
    --danger: #dc3545;
  }
  body {
    background: var(--light-bg);
    color: var(--text);
  }
  .form-container {
    max-width: 100%;
  }
  .form-control, .form-select {
    padding: .75rem .75rem;
  }
  .toast-body ul {
    margin: 0;
    padding-left: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="form-container">
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="mb-4"><i class="bi bi-person-lines-fill me-1"></i>Iniciar Atendimento</h4>
        <form id="triagemForm" novalidate>
          {% csrf_token %}
          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label">Nome do Cliente *</label>
              <input id="inputNome" name="cliente_nome" type="text" class="form-control" placeholder="Digite o nome" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Telefone *</label>
              <input name="telefone" type="text" class="form-control" placeholder="(__) _____-____" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">CPF *</label>
              <input id="inputCPF" name="cpf" type="text" class="form-control" placeholder="___.___.___-__" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">CEP</label>
              <input id="cep" name="cep" type="text" class="form-control" placeholder="_____-___">
            </div>

            <div class="col-md-6">
              <label class="form-label">Rua</label>
              <input id="rua" name="rua" type="text" class="form-control">
            </div>

            <div class="col-md-3">
              <label class="form-label">Número</label>
              <input id="numero" name="numero" type="number" class="form-control" min="0" max="200">
            </div>

            <div class="col-md-3">
              <label class="form-label">Bairro</label>
              <input id="bairro" name="bairro" type="text" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Cidade</label>
              <input id="cidade" name="cidade" type="text" class="form-control">
            </div>

            <div class="col-md-6">
              {% comment %} <label class="form-label">Cidade</label>
              <input id="cidade" name="cidade" type="text" class="form-control"> {% endcomment %}
            </div>

            {% comment %} <h5 class="mb-4"><i class="bi bi-person-lines-fill me-1"></i></h5> {% endcomment %}
            <hr>

            <div class="col-md-6">
              <label class="form-label">Atendente Responsável*</label>
              <select id="selectAtendente" name="atendente" class="form-select" required>
                <option value="">-- Selecione --</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Origem *</label>
              <select name="origem" class="form-select" required>
                <option value="">-- Escolha --</option>
                <option value="LISTA">LISTA</option>
                <option value="INDICAÇÃO">INDICAÇÃO</option>
                <option value="GOOGLE">GOOGLE</option>
                <option value="INSTAGRAM">INSTAGRAM</option>
                <option value="FACEBOOK">FACEBOOK</option>
                <option value="CLIENTE">CLIENTE</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Evento</label>
              <input id="evento" name="evento" type="text" class="form-control">
            </div>


            <div class="col-md-6">
              <label class="form-label">Papel no Evento</label>
              <input id="papelevento" name="papelevento" type="text" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Data do Evento</label>
              <input id="dataEvento" name="data_evento" type="date" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Tipo de Serviço *</label>
              <select id="tipoServico" name="tipo_servico" class="form-select" required>
                <option value="">-- Selecione --</option>
                <option value="compra">Compra</option>
                <option value="aluguel">Aluguel</option>
              </select>
            </div>


          </div>
          <div class="d-flex justify-content-end mt-4">
            <button type="submit" class="btn btn-success"><i class="bi bi-save2 me-1"></i>Salvar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Erro Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1100">
  <div id="errorToast" class="toast align-items-center border border-danger" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body text-danger"></div>
      <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('triagemForm');
  const toastEl = document.getElementById('errorToast');
  const toast = new bootstrap.Toast(toastEl);

  const nomeInput = document.getElementById('inputNome');
  const cpfInput = document.getElementById('inputCPF');
  const telefoneInput = form.querySelector('input[name="telefone"]');
  const submitBtn = form.querySelector('button[type="submit"]');

  const inputsEndereco = {
    cep: document.getElementById('cep'),
    rua: document.getElementById('rua'),
    numero: document.getElementById('numero'),
    bairro: document.getElementById('bairro'),
    cidade: document.getElementById('cidade'),
  };

  // Máscara telefone
  telefoneInput.addEventListener('input', e => {
    let v = e.target.value.replace(/\D/g, '').slice(0,11);
    if (v.length > 2) {
      const d = v.slice(0,2), n = v.slice(2);
      v = n.length > 4 ? `(${d}) ${n.slice(0, n.length-4)}-${n.slice(-4)}` : `(${d}) ${n}`;
    }
    e.target.value = v;
  });

  // Máscara CPF
  cpfInput.addEventListener('input', () => {
    let v = cpfInput.value.replace(/\D/g, '').slice(0,11);
    if (v.length > 9) v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
    else if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
    else if (v.length > 3) v = v.replace(/(\d{3})(\d{0,3})/, '$1.$2');
    cpfInput.value = v;

    // Se CPF for apagado, libera campos e limpa dados
    if (!v.replace(/\D/g, '')) {
      resetCamposCliente();
    }
  });

  // Libera campos
  function resetCamposCliente() {
    nomeInput.readOnly = false;
    cpfInput.readOnly = false;
    nomeInput.value = '';
    telefoneInput.value = '';
    Object.values(inputsEndereco).forEach(input => input.value = '');
  }

  // Busca cliente por CPF
  cpfInput.addEventListener('blur', async () => {
    const rawCpf = cpfInput.value.replace(/\D/g, '');
    if (rawCpf.length !== 11) return;

    try {
      const res = await fetch(`/clientes/buscar/?cpf=${rawCpf}`);
      if (!res.ok) throw new Error();

      const data = await res.json();

      nomeInput.value = data.nome || '';
      telefoneInput.value = data.telefone || '';
      nomeInput.readOnly = true;
      cpfInput.readOnly = true;

      if (data.endereco) {
        inputsEndereco.cep.value     = data.endereco.cep || '';
        inputsEndereco.rua.value     = data.endereco.rua || '';
        inputsEndereco.numero.value  = data.endereco.numero || '';
        inputsEndereco.bairro.value  = data.endereco.bairro || '';
        inputsEndereco.cidade.value  = data.endereco.cidade || '';
      }
    } catch {
      nomeInput.readOnly = false;
      cpfInput.readOnly = false;
    }
  });

  // VIACEP para preenchimento automático de endereço
  ['blur','input'].forEach(evt =>
    inputsEndereco.cep.addEventListener(evt, async () => {
      const cep = inputsEndereco.cep.value.replace(/\D/g, '');
      if (cep.length === 8) {
        try {
          const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
          const data = await res.json();
          if (!data.erro) {
            inputsEndereco.rua.value = data.logradouro || '';
            inputsEndereco.bairro.value = data.bairro || '';
            inputsEndereco.cidade.value = data.localidade || '';
          }
        } catch {}
      }
    })
  );

  // Submissão do formulário via AJAX
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';

    // Validação dos campos obrigatórios
    const camposObrigatorios = ['cliente_nome','telefone','cpf','atendente','origem','tipo_servico'];
    const faltando = camposObrigatorios.filter(n => !form.querySelector(`[name="${n}"]`).value);

    if (faltando.length) {
      toastEl.querySelector('.toast-body').innerHTML =
        `<strong>Campos obrigatórios faltando:</strong><ul>${faltando.map(x=>`<li>${x.replace('_', ' ')}</li>`).join('')}</ul>`;
      toast.show();
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-save2 me-1"></i>Salvar';
      return;
    }

    try {
      // Construir o objeto de dados
      const formData = new FormData(form);
      const payload = {
        cliente_nome: formData.get('cliente_nome'),
        telefone: formData.get('telefone'),
        cpf: formData.get('cpf'),
        atendente: formData.get('atendente'),
        origem: formData.get('origem'),
        evento: formData.get('evento'),
        papel_evento: formData.get('papelevento'),
        data_evento: formData.get('data_evento'),
        tipo_servico: formData.get('tipo_servico'),
        endereco: {
          cep: formData.get('cep'),
          rua: formData.get('rua'),
          numero: formData.get('numero'),
          bairro: formData.get('bairro'),
          cidade: formData.get('cidade')
        }
      };

      // Fazer a requisição AJAX
      const response = await fetch("{% url 'create_pre_service_order' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Erro ao salvar os dados');
      }

      // Sucesso - resetar o formulário
      toastEl.querySelector('.toast-body').innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill me-2"></i>Ordem de serviço criada com sucesso!</span>';
      toastEl.classList.remove('border-danger');
      toastEl.classList.add('border-success');
      toast.show();

      form.reset();
      resetCamposCliente();

    } catch (error) {
      // Tratar erros
      toastEl.querySelector('.toast-body').innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>${error.message}</span>`;
      toastEl.classList.remove('border-success');
      toastEl.classList.add('border-danger');
      toast.show();
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-save2 me-1"></i>Salvar';
    }
  });

  // Carrega atendentes
  async function carregarAtendentes() {
    try {
      const res = await fetch("{% url 'list_employees' %}");
      const data = await res.json();
      const select = document.getElementById("selectAtendente");
      select.innerHTML = '<option value="">-- Selecione --</option>';
      data.forEach(emp => {
        if (emp.role === "ATENDENTE") {
          const opt = document.createElement("option");
          opt.value = emp.name;
          opt.textContent = emp.name;
          select.appendChild(opt);
        }
      });
    } catch (err) {
      console.error("Erro ao carregar atendentes:", err);
    }
  }

  carregarAtendentes();
});
</script>
{% endblock %}
