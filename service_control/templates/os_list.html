{% extends "base_auth.html" %}
{% load static %}

{% block title %}Ordens de Serviço{% endblock %}

{% block extra_head %}
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
  <!-- AG-Grid CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css" />
  <style>
    :root {
      --primary: #0d6efd;
      --bg: #f5f6f7;
      --card-bg: #ffffff;
      --text: #212529;
      --border: #dcdcdc;
      --gap: .75rem;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Segoe UI", Roboto, sans-serif;
    }
    .main-wrapper {
      padding: 1rem;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: .375rem;
    }
    .card-header {
      background: transparent;
      border-bottom: 1px solid var(--border);
      font-size: 1.25rem;
      font-weight: 500;
    }
    .nav-tabs {
      border-bottom: 1px solid var(--border);
    }
    .nav-link {
      border: none;
      color: var(--text);
    }
    .nav-link.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      font-weight: 500;
    }
    .orders-grid {
      height: 300px;
      margin-bottom: var(--gap);
    }
    .orders-cards {
      margin-bottom: var(--gap);
    }
    .so-card {
      transition: transform .2s, box-shadow .2s;
      cursor: pointer;
    }
    .so-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    @media (max-width: 992px) {
      .nav-tabs {
        overflow-x: auto;
        white-space: nowrap;
      }
    }
    @media (max-width: 768px) {
      .card-header { font-size: 1rem; }
      .nav-link { font-size: .9rem; }
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid main-wrapper">
  <div class="card">
    <div class="card-header">
      <i class="fas fa-clipboard-list me-2"></i>Ordens de Serviço
    </div>
    <div class="card-body">

      <!-- Nav Tabs -->
      <ul class="nav nav-tabs" id="osTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pendentes-tab"
                  data-bs-toggle="tab" data-bs-target="#pendentes"
                  type="button" role="tab">Pendentes</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="aguardando-tab"
                  data-bs-toggle="tab" data-bs-target="#aguardando"
                  type="button" role="tab">Aguardando Pagamento</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="atrasadas-tab"
                  data-bs-toggle="tab" data-bs-target="#atrasadas"
                  type="button" role="tab">Atrasadas</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="concluidas-tab"
                  data-bs-toggle="tab" data-bs-target="#concluidas"
                  type="button" role="tab">Concluídas</button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content mt-3">
        <!-- Pendentes -->
        <div class="tab-pane fade show active" id="pendentes" role="tabpanel">
          <div class="d-flex justify-content-end mb-2">
            <div class="btn-group">
              <button class="btn btn-outline-primary active view-grid"><i class="fas fa-th-large"></i></button>
              <button class="btn btn-outline-primary view-cards"><i class="fas fa-th-list"></i></button>
            </div>
          </div>
          <div id="pendingGrid" class="ag-theme-quartz orders-grid"></div>
          <div id="pendingCards" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 orders-cards d-none"></div>
        </div>

        <!-- Aguardando Pagamento -->
        <div class="tab-pane fade" id="aguardando" role="tabpanel">
          <div class="d-flex justify-content-end mb-2">
            <div class="btn-group">
              <button class="btn btn-outline-primary active view-grid"><i class="fas fa-th-large"></i></button>
              <button class="btn btn-outline-primary view-cards"><i class="fas fa-th-list"></i></button>
            </div>
          </div>
          <div id="awaitingGrid" class="ag-theme-quartz orders-grid"></div>
          <div id="awaitingCards" class="row row-cols-1 row-cols-md-2 g-3 orders-cards d-none"></div>
          <nav>
            <ul id="awaitingPagination" class="pagination justify-content-center mt-3 d-none"></ul>
          </nav>
        </div>

        <!-- Atrasadas -->
        <div class="tab-pane fade" id="atrasadas" role="tabpanel">
          <div class="alert alert-secondary">Em desenvolvimento</div>
        </div>

        <!-- Concluídas -->
        <div class="tab-pane fade" id="concluidas" role="tabpanel">
          <div class="alert alert-secondary">Em desenvolvimento</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmação -->
<div class="modal fade" id="confirmPaidModal" tabindex="-1"
     role="dialog" aria-labelledby="confirmPaidLabel" aria-modal="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmPaidLabel">Confirmar Pagamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        Deseja marcar a OS <strong id="confirmPaidOsId"></strong> como paga?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="confirmPaidBtn" class="btn btn-primary">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast de confirmação -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="paidToast" class="toast align-items-center text-white bg-success border-0"
       role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Pagamento confirmado com sucesso!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast" aria-label="Fechar"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@29.3.3/dist/ag-grid-community.min.noStyle.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const modalEl   = document.getElementById('confirmPaidModal');
      const bsModal   = new bootstrap.Modal(modalEl);
      const toastEl   = document.getElementById('paidToast');
      const paidToast = new bootstrap.Toast(toastEl, { delay: 3000 });
      let selectedOsId = null;

      function openConfirmModal(osId) {
        selectedOsId = osId;
        document.getElementById('confirmPaidOsId').textContent = osId;
        bsModal.show();
      }

      document.getElementById('confirmPaidBtn').addEventListener('click', () => {
        fetch(`/os/${selectedOsId}/mark_paid/`, {
          method: 'POST',
          headers: {'X-CSRFToken': getCookie('csrftoken')}
        })
        .then(r => r.json())
        .then(() => {
          bsModal.hide();
          paidToast.show();
          document.querySelector('#aguardando-tab')
                  .dispatchEvent(new Event('shown.bs.tab'));
        })
        .catch(console.error);
      });

      function getCookie(name) {
        let v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
        return v ? decodeURIComponent(v.split('=')[1]) : '';
      }

      const tabsConfig = {
        pendentes: {
          url: "{% url 'list_pending_service_orders' %}",
          gridId: 'pendingGrid',
          cardsId: 'pendingCards',
          paginationId: null,
          tabBtnId: 'pendentes-tab',
          tabContentId: 'pendentes',
          paginate: false,
          perPage: null,
          columns: [
            { headerName:"ID", field:"id", maxWidth:90, sort:'desc',
              cellRenderer: p=>`<a href="/os/${p.value}/">${p.value}</a>` },
            { headerName:"Cliente", field:"cliente", flex:1, minWidth:120 },
            { headerName:"CPF", field:"cpf", width:150 },
            { headerName:"Telefone", field:"telefone", width:150 },
            { headerName:"Atendente", field:"atendente", flex:1, minWidth:120 },
            { headerName:"Data OS", field:"data_ordem", width:120 },
            { headerName:"Data Evento", field:"data_evento", width:120 },
            { headerName:"Ocasião", field:"ocasiao", width:150 },
            { headerName:"Origem", field:"origem", width:120 },
            { headerName:"Tipo", field:"tipo_servico", width:120 }
          ],
          cardBuilder(container,data){
            container.innerHTML='';
            data.forEach(os=>{
              const col = document.createElement('div'); col.className='col';
              const card = document.createElement('div'); card.className='card so-card shadow-sm h-100';
              card.innerHTML=`
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title mb-2">OS #${os.id} – ${os.cliente}</h5>
                  <p class="mb-1"><strong>Atendente:</strong> ${os.atendente}</p>
                  <p class="mb-1"><strong>Evento:</strong> ${os.data_evento}</p>
                  <p class="mb-1"><strong>Ocasião:</strong> ${os.ocasiao}</p>
                  <p class="mb-1"><strong>Origem:</strong> ${os.origem}</p>
                  <div class="mt-auto text-muted"><small>CPF: ${os.cpf} | Tel: ${os.telefone}</small></div>
                </div>`;
              card.addEventListener('click',()=>location.href=`/os/${os.id}/`);
              col.append(card); container.append(col);
            });
          }
        },
        aguardando: {
          url: "{% url 'list_awaiting_payment_service_orders' %}",
          gridId: 'awaitingGrid',
          cardsId: 'awaitingCards',
          paginationId: 'awaitingPagination',
          tabBtnId: 'aguardando-tab',
          tabContentId: 'aguardando',
          paginate: true,
          perPage: 10,
          columns: [
            { headerName:"ID", field:"id", maxWidth:90, sort:'desc',
              cellRenderer: p=>`<a href="/os/${p.value}/">${p.value}</a>` },
            { headerName:"Cliente", field:"cliente", flex:1, minWidth:120 },
            { headerName:"Data OS", field:"data_ordem", width:120 },
            { headerName:"Data Evento", field:"data_evento", width:120 },
            { headerName:"Valor Total", field:"valor_total", width:120 },
            { headerName:"Pago", field:"valor_pago", width:120 },
            { headerName:"Faltando", field:"valor_faltando", width:140 },
            { headerName:"Método", field:"metodo_pagamento", width:140 },
            { headerName:"Ações", field:"id", maxWidth:130,
              cellRenderer: p=>`<button class="btn btn-sm btn-success mark-paid" data-id="${p.value}">Marcar Pago</button>` }
          ],
          cardBuilder(container,data){
            container.innerHTML='';
            data.forEach(os=>{
              const col=document.createElement('div'); col.className='col';
              const card=document.createElement('div'); card.className='card so-card shadow-sm h-100';
              card.innerHTML=`
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-0">OS #${os.id} – ${os.cliente}</h5>
                    <small>Falta pagar: R$ ${os.valor_faltando.toFixed(2)}</small>
                  </div>
                  <button class="btn btn-sm btn-success mark-paid" data-id="${os.id}">Marcar Pago</button>
                </div>
                <div class="card-body">
                  <p><strong>Data Evento:</strong> ${os.data_evento}</p>
                  <p><strong>Ocasião:</strong> ${os.ocasiao}</p>
                  <p><strong>Origem:</strong> ${os.origem}</p>
                  <p><strong>Tipo:</strong> ${os.tipo_servico}</p>
                  <table class="table table-sm">
                    <thead><tr><th>Produto</th><th>Cor</th><th>Ajuste</th><th>Valor Ajuste</th><th>Obs</th></tr></thead>
                    <tbody>
                      ${os.itens.map(item=>`
                        <tr>
                          <td>${item.produto}</td>
                          <td>${item.cor}</td>
                          <td>${item.ajuste?'Sim':'Não'}</td>
                          <td>${item.valor_ajuste} cm</td>
                          <td>${item.obs_ajuste}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>`;
              col.append(card); container.append(col);
            });
          }
        }
      };

      Object.values(tabsConfig).forEach(cfg => {
        const gridDiv  = document.getElementById(cfg.gridId);
        const cardsDiv = document.getElementById(cfg.cardsId);
        const pagUl    = cfg.paginationId ? document.getElementById(cfg.paginationId) : null;
        const viewGrid = document.querySelector(`#${cfg.tabContentId} .view-grid`);
        const viewCards= document.querySelector(`#${cfg.tabContentId} .view-cards`);
        let allData = [];

        const gridOptions = {
          columnDefs: cfg.columns,
          defaultColDef: { sortable:true, filter:true, resizable:true },
          pagination:true, paginationPageSize:20,
          onGridReady: () => loadData(1),
          onCellClicked: e => {
            if (e.event.target.classList.contains('mark-paid')) {
              openConfirmModal(e.data.id);
            }
          }
        };
        new agGrid.Grid(gridDiv, gridOptions);

        function loadData(page=1){
          fetch(cfg.url).then(r => r.json()).then(json => {
            allData = json.data;
            gridOptions.api.setRowData(allData);
            if (!cardsDiv.classList.contains('d-none')) renderCards(page);
          });
        }

        viewGrid.addEventListener('click', () => {
          gridDiv.classList.remove('d-none'); cardsDiv.classList.add('d-none');
          if (pagUl) pagUl.classList.add('d-none');
          viewGrid.classList.add('active'); viewCards.classList.remove('active');
        });
        viewCards.addEventListener('click', () => {
          gridDiv.classList.add('d-none'); cardsDiv.classList.remove('d-none');
          if (pagUl) pagUl.classList.remove('d-none');
          viewCards.classList.add('active'); viewGrid.classList.remove('active');
          renderCards(1);
        });

        document.getElementById(cfg.tabBtnId)
                .addEventListener('shown.bs.tab', () => loadData(1));

        function renderCards(page){
          let slice = allData;
          if (cfg.paginate){
            const totalPages = Math.ceil(allData.length / cfg.perPage);
            const start = (page - 1) * cfg.perPage;
            slice = allData.slice(start, start + cfg.perPage);
            renderPagination(totalPages, page);
          }
          cardsDiv.innerHTML = '';
          cfg.cardBuilder(cardsDiv, slice);
        }

        function renderPagination(totalPages, current){
          pagUl.innerHTML = '';
          for (let i = 1; i <= totalPages; i++){
            const li = document.createElement('li');
            li.className = `page-item${i===current?' active':''}`;
            const a = document.createElement('a');
            a.className = 'page-link'; a.href='#'; a.textContent = i;
            a.onclick = e => { e.preventDefault(); renderCards(i); };
            li.append(a); pagUl.append(li);
          }
        }
      });

    });
  </script>
{% endblock %}
