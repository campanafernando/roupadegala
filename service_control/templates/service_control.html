{% extends "base_auth.html" %}
{% load static %}

{% block title %}Ordens de Serviço{% endblock title %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css" rel="stylesheet">

<style>
  .form-select, .form-control {
    background-color: var(--input-bg-color);
    color: var(--text-color);
    border: 1px solid var(--modal-border-color);
  }
  label {
    font-weight: bold;
  }
  .card {
    border: 1px solid rgb(189, 189, 189);
    padding-top: 50px;
    transition: 0.5s;
    margin-top: 10px;
    padding: 15px;
    display: flex;
    box-shadow: 1px 1px 5px 0px #9c9c9c;
    border-radius: 15px;
    width: 520px;
    justify-content: center;
    position: relative;
    background-color: var(--bg-color);
  }
  .cliente-info, .contrato-info {
    display: flex;
    flex-direction: column;
    margin-left: 10px;
  }
  .cliente-info p, .contrato-info p {
    font-size: 13px;
    margin: 5px 0;
    color: var(--text-color);
  }
  .saldos {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 7px;
    margin-top: 15px;
    background-color: var(--card-bg-color);
    border-radius: 15px;
    padding: 10px;
    width: 100%;
  }
</style>
{% endblock extra_head %}

{% block content %}
<div class="container mt-4">
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-coreui-toggle="tab" data-coreui-target="#cadastro" type="button">
        Cadastrar OS
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-coreui-toggle="tab" data-coreui-target="#listagem" type="button">
        Listar OS
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Aba de Cadastro -->
    <div class="tab-pane fade show active" id="cadastro" role="tabpanel">
      <form method="POST">
        {% csrf_token %}

        <!-- === Seção 1: Dados do Cliente === -->
        <h5>Dados do Cliente</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="cliente_nome">Nome do Cliente</label>
            <input id="cliente_nome" type="text" name="cliente_nome" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label for="telefone">Telefone</label>
            <input id="telefone" type="text" name="telefone" class="form-control">
          </div>
          <div class="col-md-4">
            <label for="cpf">CPF</label>
            <input id="cpf" type="text" name="cpf" class="form-control">
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-3">
            <label for="cep">CEP</label>
            <input id="cep" type="text" name="cep" class="form-control">
          </div>
          <div class="col-md-6">
            <label for="rua">Rua</label>
            <input id="rua" type="text" name="rua" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="numero">Número</label>
            <input id="numero" type="text" name="numero" class="form-control">
          </div>
        </div>
        <div class="row mb-4">
          <div class="col-md-6">
            <label for="bairro">Bairro</label>
            <input id="bairro" type="text" name="bairro" class="form-control">
          </div>
          <div class="col-md-6">
            <label for="cidade">Cidade</label>
            <input id="cidade" type="text" name="cidade" class="form-control">
          </div>
        </div>

        <hr>

        <!-- === Seção 2: Itens do Traje === -->
        <h5>Itens do Traje</h5>
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="paleto">Paletó Nº</label>
            <input id="paleto" type="text" name="paleto" class="form-control">
          </div>
          <div class="col-md-6">
            <label for="cor_paleto">Cor do Paletó</label>
            <select id="cor_paleto" name="cor_paleto" class="form-select color-select" required></select>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="camisa">Camisa Nº</label>
            <input id="camisa" type="text" name="camisa" class="form-control">
          </div>
          <div class="col-md-6">
            <label for="cor_camisa">Cor da Camisa</label>
            <select id="cor_camisa" name="cor_camisa" class="form-select color-select" required></select>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="calca">Calça Nº</label>
            <input id="calca" type="text" name="calca" class="form-control">
          </div>
          <div class="col-md-6">
            <label for="cor_calca">Cor da Calça</label>
            <select id="cor_calca" name="cor_calca" class="form-select color-select" required></select>
          </div>
        </div>
        <div class="row mb-4">
          <div class="col-md-4">
            <label for="sapato">Sapato Nº</label>
            <input id="sapato" type="text" name="sapato" class="form-control">
          </div>
          <div class="col-md-4">
            <label for="gravata">Gravata</label>
            <input id="gravata" type="text" name="gravata" class="form-control">
          </div>
          <div class="col-md-4">
            <label for="colete">Coletes / Suspensórios</label>
            <input id="colete" type="text" name="colete" class="form-control">
          </div>
        </div>

        <hr>

        <!-- === Seção 3: Pagamento === -->
        <h5>Pagamento</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="valor_total">Valor Total</label>
            <input id="valor_total" type="number" step="0.01" name="valor_total" class="form-control">
          </div>
          <div class="col-md-4">
            <label for="valor_sinal">Valor Sinalizado</label>
            <input id="valor_sinal" type="number" step="0.01" name="valor_sinal" class="form-control">
          </div>
          <div class="col-md-4">
            <label for="valor_restante">Valor Restante</label>
            <input id="valor_restante" type="number" step="0.01" name="valor_restante" class="form-control">
          </div>
        </div>

        <button class="btn btn-primary" type="submit">Salvar OS</button>
      </form>
    </div>

    <!-- Aba de Listagem (sem alterações) -->
    <div class="tab-pane fade" id="listagem" role="tabpanel">
      <div class="wrapper mt-4">
        <div class="card">
          <h2>OS: #00012</h2>
          <div class="cliente-info">
            <p><strong>Cliente:</strong> Vinícius</p>
            <p><strong>Telefone:</strong> (34) 99999-9999</p>
            <p><strong>Retirada:</strong> 17/04/2025</p>
            <p><strong>Devolução:</strong> 20/05/2025</p>
            <p><strong>Status:</strong> Em andamento</p>
          </div>
          <div class="saldos">
            <p>Valor Total: <span>R$ 130,00</span></p>
            <p>Valor Sinal: <span>R$ 50,00</span></p>
            <p>Valor Restante: <span>R$ 80,00</span></p>
            <p>Atendente: <span>MT</span></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_scripts %}
<script>
  // utilitário CSRF (igual antes)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      document.cookie.split(';').forEach(c => {
        c = c.trim();
        if (c.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(c.substring(name.length + 1));
        }
      });
    }
    return cookieValue;
  }

  document.addEventListener("DOMContentLoaded", function () {
    // <<< desativa toda validação HTML5 >>>
    const form = document.querySelector("form");
    form.noValidate = true;

    // --- 1) Mantém aba ativa ---
    const savedTab = localStorage.getItem("activeTab");
    if (savedTab) {
      const trigger = document.querySelector(`[data-coreui-target="${savedTab}"]`);
      if (trigger) new coreui.Tab(trigger).show();
    }
    document.querySelectorAll('[data-coreui-toggle="tab"]').forEach(btn => {
      btn.addEventListener("click", () => {
        localStorage.setItem("activeTab", btn.getAttribute("data-coreui-target"));
      });
    });

    // --- 2) Carrega cores ---
    fetch("{% url 'list_colors' %}")
      .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
      .then(data => {
        document.querySelectorAll(".color-select").forEach(sel => {
          sel.innerHTML = '<option value="">Selecione uma cor</option>';
          data.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.id;
            opt.textContent = item.description;
            sel.appendChild(opt);
          });
        });
      })
      .catch(err => {
        console.error("Erro ao carregar cores:", err);
        document.querySelectorAll(".color-select").forEach(sel => {
          sel.innerHTML = '<option value="">Erro ao carregar</option>';
        });
      });

    // --- 3) ViaCEP + limpeza de campos se o CEP for apagado ---
    const cepInput = document.getElementById("cep");
    const ruaEl    = document.getElementById("rua");
    const bairroEl = document.getElementById("bairro");
    const cidadeEl = document.getElementById("cidade");

    cepInput.addEventListener("blur", () => {
      const raw = cepInput.value.replace(/\D/g, "");
      if (raw.length === 8) {
        fetch(`https://viacep.com.br/ws/${raw}/json/`)
          .then(r => r.json())
          .then(data => {
            if (!data.erro) {
              ruaEl.value    = data.logradouro;
              bairroEl.value = data.bairro;
              cidadeEl.value = data.localidade;
            } else {
              alert("CEP não encontrado.");
              ruaEl.value = bairroEl.value = cidadeEl.value = "";
            }
          })
          .catch(() => {
            alert("Erro ao consultar CEP.");
            ruaEl.value = bairroEl.value = cidadeEl.value = "";
          });
      } else {
        // apagou ou inválido → limpa
        ruaEl.value = bairroEl.value = cidadeEl.value = "";
      }
    });

    // --- 4) Intercepta o submit e cadastra cliente via AJAX ---
    form.addEventListener("submit", function (e) {
      e.preventDefault();  // já que estamos no teste, não submete o OS

      const csrftoken = getCookie('csrftoken');
      const payload = {
        nome:     document.getElementById("cliente_nome").value,
        telefone: document.getElementById("telefone").value,
        cpf:      document.getElementById("cpf").value,
        cep:      cepInput.value,
        rua:      ruaEl.value,
        numero:   document.getElementById("numero").value,
        bairro:   bairroEl.value,
        cidade:   cidadeEl.value
      };

      fetch("{% url 'register_client' %}", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(payload)
      })
      .then(res => res.json().then(json => ({ status: res.status, body: json })))
      .then(({ status, body }) => {
        if (status >= 200 && status < 300) {
          console.log("✅ Cliente cadastrado:", body);
          alert("Cliente cadastrado com sucesso! Confira o console.");
        } else {
          console.error("❌ Erro ao cadastrar cliente:", body);
          alert("Falha ao cadastrar cliente: " + (body.error || "veja console"));
        }
      })
      .catch(err => {
        console.error("❌ Erro de rede:", err);
        alert("Erro de rede ao cadastrar cliente.");
      });
    });

  });
</script>
{% endblock extra_scripts %}
