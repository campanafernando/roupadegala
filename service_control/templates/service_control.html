{% extends "base_auth.html" %}
{% load static %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root {
    --primary: #0069d9;
    --light-bg: #f8f9fa;
    --card-bg: #ffffff;
    --border: #dee2e6;
    --text: #212529;
    --danger: #dc3545;
  }
  body {
    background: var(--light-bg);
    color: var(--text);
  }
  .d-flex.main { gap: 1rem; }

  .main.summary-collapsed .summary-sidebar {
    width: 0;
    opacity: 0;
    pointer-events: none;
  }
  .main.summary-collapsed .form-container {
    max-width: 100% !important;
  }


  /* 1) Formul√°rio maior: subtra√≠mos agora 600px (tamanho da sidebar) */
  .form-container {
    flex-grow: 1;
    max-width: calc(100% - 600px);
    transition: max-width .3s ease;
  }
  .list-mode .form-container {
    max-width: 100% !important;
  }

  /* 2) Sidebar de resumo tamb√©m ajustada para 600px */
  .summary-sidebar {
    width: 600px;
    flex-shrink: 0;
    background: var(--card-bg);
    border-left: 2px solid var(--primary);
    padding: 1rem;
    max-height: 90vh;
    overflow-y: auto;
    transition: opacity .3s ease, width .3s ease;
  }
  .list-mode .summary-sidebar {
    opacity: 0;
    width: 0;
    pointer-events: none;
  }

  /* 3) Campos ‚ÄúCor‚Äù (e todo col-md-2) um pouco mais largos em telas m√©dias para evitar estouro */
  @media (min-width: 768px) {
    .form-container .col-md-2 {
      flex: 0 0 18%;
      max-width: 18%;
    }
  }

  .form-control, .form-select {
    padding: .75rem .75rem;
  }

  /* Stepper */
  .stepper {
    display: flex;
    justify-content: space-between;
    margin: 2rem 0;
    position: relative;
  }
  {% comment %} .stepper::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 2rem;
    right: 2rem;
    height: 2px;
    background: var(--border);
    z-index: 0;
  } {% endcomment %}
  .step {
    position: relative;
    z-index: 1;
    text-align: center;
    flex: 1;
  }
  .step-circle {
    display: inline-block;
    width: 2.5rem;
    height: 2.5rem;
    line-height: 2.5rem;
    border-radius: 50%;
    border: 2px solid var(--border);
    background: var(--card-bg);
    transition: .3s;
  }
  .step-label {
    margin-top: .3rem;
    font-size: .9rem;
    display: block;
  }
  .step.active .step-circle,
  .step.completed .step-circle {
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
  }
  .step.active .step-label,
  .step.completed .step-label {
    color: var(--primary);
  }

  /* Form steps */
  .form-step {
    display: none;
    animation: fadeIn .3s;
  }
  .form-step.active { display: block; }
  @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }

  /* Resumo */
  .summary-sidebar h5 {
    color: var(--primary);
    margin-bottom: 1rem;
    font-weight: 600;
  }
  .summary-section {
    margin-bottom: 1.5rem;
    display: none;
  }
  .summary-section h6 {
    margin-bottom: .5rem;
    font-weight: 600;
    font-size: 1rem;
    color: var(--primary);
  }
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* cada cart√£o m√≠nimo de 160px */
    gap: .5rem;
  }
  .summary-item {
    background: var(--light-bg);
    border: 1px solid var(--border);
    border-radius: .25rem;
    padding: .4rem .6rem;
    font-size: .85rem;
  }
  .summary-item .label {
    font-weight: 600;
    margin-right: .25rem;
  }

  /* Erros em toast */
  .toast-body ul {
    margin: 0;
    padding-left: 1rem;
  }
</style>
{% endblock %}


{% block content %}
<div class="container my-4">
  <button id="toggleSummary" class="btn btn-outline-secondary mb-3">
    <i class="bi bi-list"></i> Mostrar/ocultar Resumo
  </button>

  <div class="d-flex main">

    <!-- Form -->
    <div class="form-container">
      <div class="card shadow-sm">
        <div class="card-body">

          {% comment %} <!-- Tabs -->
          <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
              <button class="nav-link active" data-coreui-toggle="tab" data-coreui-target="#cadastro">üìù Cadastrar OS</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-coreui-toggle="tab" data-coreui-target="#listagem">üìã Listar OS</button>
            </li>
          </ul> {% endcomment %}

          <div class="tab-content">

            <!-- Cadastro OS -->
            <div class="tab-pane fade show active" id="cadastro">

              <!-- Stepper -->
              <div class="stepper">
                <div class="step active" data-step="1">
                  <span class="step-circle"><i class="bi bi-person"></i></span>
                  <span class="step-label">Cliente</span>
                </div>
                <div class="step" data-step="2">
                  <span class="step-circle"><i class="bi bi-suit-club-fill"></i></span>
                  <span class="step-label">Terno</span>
                </div>
                <div class="step" data-step="3">
                  <span class="step-circle"><i class="bi bi-person-hearts"></i></span>
                  <span class="step-label">Camisa</span>
                </div>
                <div class="step" data-step="4">
                  <span class="step-circle"><i class="bi bi-gem"></i></span>
                  <span class="step-label">Acess√≥rios</span>
                </div>
                <div class="step" data-step="5">
                  <span class="step-circle"><i class="bi bi-cash-coin"></i></span>
                  <span class="step-label">Pagamento</span>
                </div>
              </div>

              <form id="osForm" novalidate>
                {% csrf_token %}

                <!-- STEP 1: Cliente -->
                <div class="form-step active" data-step="1">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Nome *</label>
                      <input id="cliente_nome" name="cliente_nome" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Telefone *</label>
                      <input id="telefone"   name="telefone" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">CPF *</label>
                      <input id="cpf" name="cpf" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">CEP</label>
                      <input id="cep" name="cep" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Rua</label>
                      <input id="rua" name="rua" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">N√∫mero</label>
                      <input id="numero" name="numero" type="number" class="form-control" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Bairro</label>
                      <input id="bairro" name="bairro" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Cidade</label>
                      <input id="cidade" name="cidade" type="text" class="form-control" readonly>
                    </div>
                  </div>
                  <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 2: Terno -->
                <div class="form-step" data-step="2">
                  <div class="row g-3">
                    <!-- Linha 1: Marca e Tecido -->
                    <div class="col-md-6">
                      <label class="form-label">Marca do Terno *</label>
                      <input name="terno_marca" type="text" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Tecido do Terno *</label>
                      <input name="terno_tecido" type="text" class="form-control" required>
                    </div>

                    <!-- Linha 2: Palet√≥ -->
                    <div class="col-md-2">
                      <label class="form-label">N¬∫ Palet√≥ *</label>
                      <input name="paleto" type="number" class="form-control" min="0" max="200" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Cor Palet√≥ *</label>
                      <select name="cor_paleto" class="form-select color-select" required></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Manga Palet√≥ *</label>
                      <input name="paleto_mg" type="number" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Ajuste Palet√≥?</label>
                      <select name="paleto_ajuste" class="form-select toggle-dependent" data-target=".paleto-ajuste">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 paleto-ajuste dependent-field" style="display:none">
                      <label class="form-label">Ajuste Palet√≥ (cm)</label>
                      <input name="paleto_ajuste_cm" type="number" step="0.5" class="form-control" disabled>
                    </div>

                    <!-- Linha 3: Colete -->
                    <div class="col-md-2">
                      <label class="form-label">Colete?</label>
                      <select name="colete_presente" class="form-select toggle-dependent" data-target=".colete-cor">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 colete-cor dependent-field" style="display:none">
                      <label class="form-label">Cor do Colete</label>
                      <select name="cor_colete" class="form-select color-select" disabled></select>
                    </div>

                    <!-- Linha 4: Cal√ßa -->
                    <div class="col-md-2">
                      <label class="form-label">N¬∫ Cal√ßa *</label>
                      <input name="calca" type="number" class="form-control" min="0" max="200" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Cor Cal√ßa *</label>
                      <select name="cor_calca" class="form-select color-select" required></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Cintura Cal√ßa *</label>
                      <input name="calca_cp" type="number" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Perna Cal√ßa *</label>
                      <input name="calca_perna" type="number" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Ajuste Cal√ßa?</label>
                      <select name="calca_ajuste" class="form-select toggle-dependent" data-target=".calca-ajuste">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 calca-ajuste dependent-field" style="display:none">
                      <label class="form-label">Ajuste Cal√ßa (cm)</label>
                      <input name="calca_ajuste_cm" type="number" step="0.5" class="form-control" disabled>
                    </div>
                  </div>

                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 3: Camisa -->
                <div class="form-step" data-step="3">
                  <div class="row g-3">
                    <div class="col-md-2">
                      <label class="form-label">N¬∫ *</label>
                      <input name="camisa" type="number" class="form-control" min="0" max="200" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Cor *</label>
                      <select name="cor_camisa" class="form-select color-select" required></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Manga *</label>
                      <input name="camisa_mg" type="number" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Marca *</label>
                      <input name="camisa_marca" type="text" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Ajuste?</label>
                      <select name="camisa_ajuste" class="form-select toggle-dependent" data-target=".camisa-ajuste">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 camisa-ajuste dependent-field" style="display:none">
                      <label class="form-label">Ajuste (cm)</label>
                      <input name="camisa_ajuste_cm" type="number" step="0.5" class="form-control" disabled>
                    </div>
                    {% comment %} <div class="col-md-4">
                      <label class="form-label">Extras</label>
                      <input name="camisa_ajustes_adicionais" type="text" class="form-control">
                    </div> {% endcomment %}
                  </div>

                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 5: Acess√≥rios -->
                <div class="form-step" data-step="4">
                  <div class="row g-3">
                    <div class="col-md-2">
                      <label class="form-label">Suspens√≥rio?</label>
                      <select name="suspensorio_sim" class="form-select toggle-dependent" data-target=".suspensorio-info">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 suspensorio-info dependent-field" style="display:none">
                      <label class="form-label">Cor</label>
                      <select name="suspensorio_cor" class="form-select color-select"></select>
                    </div>

                    <div class="col-md-2">
                      <label class="form-label">Len√ßo?</label>
                      <select name="lenco_sim" class="form-select toggle-dependent" data-target=".lenco-info">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 lenco-info dependent-field" style="display:none">
                      <label class="form-label">Cor</label>
                      <select name="lenco_cor" class="form-select color-select"></select>
                    </div>

                    <div class="col-md-2">
                      <label class="form-label">Passante?</label>
                      <select name="passante_sim" class="form-select toggle-dependent" data-target=".passante-info">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 passante-info dependent-field" style="display:none">
                      <label class="form-label">Cor</label>
                      <select name="passante_cor" class="form-select color-select"></select>
                    </div>

                    <div class="col-md-2">
                      <label class="form-label">Sapato?</label>
                      <select name="sapato_sim" class="form-select toggle-dependent" data-target=".sapato-info">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 sapato-info dependent-field" style="display:none">
                      <label class="form-label">Tipo</label>
                      <input name="sapato_tipo" type="text" class="form-control">
                    </div>
                    <div class="col-md-2 sapato-info dependent-field" style="display:none">
                      <label class="form-label">N¬∫</label>
                      <input name="sapato_numero" type="number" class="form-control" min="0" max="200">
                    </div>
                  </div>
                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 6: Pagamento -->
                <div class="form-step" data-step="5">
                  <div class="row g-3">
                    {% comment %} <div class="col-md-4">
                      <label class="form-label">Data do Pedido *</label>
                      <input name="order_date" type="date" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Data do Evento *</label>
                      <input name="event_date" type="date" class="form-control" required>
                    </div> {% endcomment %}
                    <div class="col-md-4">
                      <label class="form-label">Forma de Pagamento *</label>
                      <select name="forma_pagamento" class="form-select" required>
                        <option value="">Selecione...</option>
                        <option value="CREDITO">CR√âDITO</option>
                        <option value="DEBITO">D√âBITO</option>
                        <option value="PIX">PIX</option>
                        <option value="DINHEIRO">DINHEIRO</option>
                        <option value="CHEQUE">CHEQUE</option>
                      </select>
                    </div>
                    {% comment %} <div class="col-md-3">
                      <label class="form-label">Tipo *</label>
                      <select name="purchase" class="form-select" required>
                        <option value="false" selected>Loca√ß√£o</option>
                        <option value="true">Compra</option>
                      </select>
                    </div> {% endcomment %}
                  </div>
                  <div class="row g-3 mt-3">
                    <div class="col-md-4">
                      <label class="form-label">Total (R$) *</label>
                      <input name="valor_total" type="text" class="form-control" placeholder="0.00" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Sinal (R$) *</label>
                      <input name="valor_sinal" type="text" class="form-control" placeholder="0.00" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Restante (R$)</label>
                      <input name="valor_restante" type="text" class="form-control" placeholder="0.00" readonly>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="submit" class="btn btn-success">Salvar OS</button>
                  </div>
                </div>

              </form>

            </div>

            {% comment %} <!-- Listagem -->
            <div class="tab-pane fade" id="listagem">
              <div id="osGrid" class="ag-theme-quartz"></div>
            </div> {% endcomment %}

            {% comment %} <div class="tab-pane fade" id="listagem">
              <div class="row g-4">
                {% for os in ordens %}
                  <div class="col-md-4">
                    <div class="card h-100">
                      <div class="card-header">OS #{{ os.id }}</div>
                      <div class="card-body">
                        <p><strong>Cliente:</strong> {{ os.renter.name }}</p>
                        <p><strong>Telefone:</strong> {{ os.renter.personscontacts.first.phone }}</p>
                        <hr>
                        <p><strong>Total:</strong> R$ {{ os.total_value }}</p>
                        <p><strong>Sinal:</strong> R$ {{ os.advance_payment }}</p>
                        <p><strong>Restante:</strong> R$ {{ os.remaining_payment }}</p>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div class="col-12 text-center text-muted">Nenhuma ordem cadastrada.</div>
                {% endfor %}
              </div>
            </div> {% endcomment %}

          </div>
        </div>
      </div>
    </div>

    <!-- Summary Sidebar -->
    <div class="summary-sidebar">
      <h5><i class="bi bi-clipboard-check me-1"></i>Resumo</h5>
      <div id="liveSummary">
        <div class="summary-section" data-section="Cliente">
          <h6><i class="bi bi-person-fill me-1"></i>Cliente</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Terno">
          <h6><i class="bi bi-suit-club-fill me-1"></i>Terno</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Camisa">
          <h6><i class="bi bi-person-hearts"></i>Camisa</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Acess√≥rios">
          <h6><i class="bi bi-gem me-1"></i>Acess√≥rios</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Pagamento">
          <h6><i class="bi bi-cash-coin me-1"></i>Pagamento</h6>
          <div class="summary-grid"></div>
        </div>
      </div>
    </div>


  </div>
</div>

<!-- Error Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1100;">
  <div id="errorToast" class="toast align-items-center border border-danger" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body text-danger"></div>
      <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- Vari√°veis iniciais ---
  const osId     = {{ order_id|default:"null" }};
  let orderId    = null;
  const form     = document.getElementById('osForm');
  const toastEl  = document.getElementById('errorToast');
  const toast    = new bootstrap.Toast(toastEl);
  const mainEl   = document.querySelector('.d-flex.main');
  const toggleBtn= document.getElementById('toggleSummary');

  // --- Busca dados do cliente e preenche o form ---
  fetch(`/os/${osId}/cliente/`, {
    credentials: 'same-origin',
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(res => {
    if (!res.ok) throw new Error('N√£o foi poss√≠vel carregar dados do cliente');
    return res.json();
  })
  .then(({ data }) => {
    orderId = data.order_id;
    document.getElementById('cliente_nome').value = data.nome || '';
    document.getElementById('cpf').value          = data.cpf  || '';
    document.getElementById('telefone').value     = data.telefones?.[0] || '';
    if (data.enderecos?.length) {
      const addr = data.enderecos[0];
      ['cep','rua','numero','bairro','cidade'].forEach((id,i) =>
        document.getElementById(id).value = addr[['cep','logradouro','numero','bairro','localidade'][i]] || ''
      );
    }
  })
  .catch(console.error);

  // --- Toggle de resumo ---
  toggleBtn.addEventListener('click', () => {
    mainEl.classList.toggle('summary-collapsed');
  });

  // --- Helper CSRF ---
  function getCookie(name) {
    let v = document.cookie.split(';').find(c=>c.trim().startsWith(name+'='));
    return v ? decodeURIComponent(v.split('=')[1]) : null;
  }
  const csrftoken = getCookie('csrftoken');

  // --- Stepper & navega√ß√£o ---
  const steps = [...document.querySelectorAll('.step')];
  const panes = [...document.querySelectorAll('.form-step')];
  let current = 1;
  function showStep(n) {
    panes.forEach(p => p.classList.toggle('active', +p.dataset.step === n));
    steps.forEach(s => {
      const idx = +s.dataset.step;
      s.classList.toggle('active', idx === n);
      s.classList.toggle('completed', idx < n);
    });
    current = n;
  }
  document.querySelectorAll('[data-action=next]').forEach(btn =>
    btn.addEventListener('click', ()=> current < panes.length && showStep(current+1))
  );
  document.querySelectorAll('[data-action=prev]').forEach(btn =>
    btn.addEventListener('click', ()=> current > 1 && showStep(current-1))
  );
  form.addEventListener('keydown', e => {
    if (e.key==='Enter' && e.target.tagName!=='TEXTAREA') e.preventDefault();
  });

  // --- Summary builder ---
  function updateSummary() {
    const fd = new FormData(form);
    ['Cliente','Terno','Camisa','Acess√≥rios','Pagamento'].forEach(section => {
      const secEl = document.querySelector(`.summary-section[data-section="${section}"]`);
      const grid  = secEl.querySelector('.summary-grid');
      grid.innerHTML = '';
      if (section==='Terno') return updateTernoSummary(fd);
      const map = {
        'Cliente': [['cliente_nome','Nome'],['telefone','Telefone'],['cpf','CPF'],['rua','Rua'],['numero','N√∫mero'],['bairro','Bairro'],['cidade','Cidade']],
        'Camisa':  [['camisa','N¬∫'],['cor_camisa','Cor'],['camisa_mg','Manga']],
        'Acess√≥rios': [['suspensorio_sim','Suspens√≥rio'],['suspensorio_cor','Cor Suspens√≥rio',f=>f.get('suspensorio_sim')==='yes'],['lenco_sim','Len√ßo'],['lenco_cor','Cor Len√ßo',f=>f.get('lenco_sim')==='yes'],['passante_sim','Passante'],['passante_cor','Cor Passante',f=>f.get('passante_sim')==='yes'],['sapato_sim','Sapato'],['sapato_tipo','Tipo',f=>f.get('sapato_sim')==='yes'],['sapato_numero','N¬∫',f=>f.get('sapato_sim')==='yes']],
        'Pagamento': [['forma_pagamento','M√©todo'],['valor_total','Total'],['valor_sinal','Sinal'],['valor_restante','Restante']]
      }[section]||[];
      map.forEach(([k,label,cond])=>{
        if((!cond||cond(fd)) && fd.get(k)){
          let v = fd.get(k);
          const el = form.querySelector(`[name="${k}"]`);
          if(el?.tagName==='SELECT') v=el.options[el.selectedIndex].text;
          const d = document.createElement('div');
          d.className='summary-item';
          d.innerHTML=`<span class="label">${label}:</span>${v}`;
          grid.appendChild(d);
        }
      });
      secEl.style.display = grid.children.length?'block':'none';
    });
  }
  function updateTernoSummary(fd){
    const secEl = document.querySelector('.summary-section[data-section="Terno"]');
    const grid  = secEl.querySelector('.summary-grid');
    grid.innerHTML='';
    [['terno_marca','Marca'],['terno_tecido','Tecido'],['paleto','Palet√≥ N¬∫'],['cor_paleto','Cor Palet√≥'],['paleto_mg','Palet√≥ Manga'],['paleto_ajuste_cm','Ajuste Palet√≥',f=>f.get('paleto_ajuste')==='yes'],['calca','Cal√ßa N¬∫'],['cor_calca','Cor Cal√ßa'],['calca_cp','Cintura'],['calca_perna','Perna'],['calca_ajuste_cm','Ajuste Cal√ßa',f=>f.get('calca_ajuste')==='yes']].forEach(([k,label,cond])=>{
      if((!cond||cond(fd))&&fd.get(k)){
        let v=fd.get(k);
        const el=form.querySelector(`[name="${k}"]`);
        if(el?.tagName==='SELECT') v=el.options[el.selectedIndex].text;
        const d=document.createElement('div');
        d.className='summary-item';
        d.innerHTML=`<span class="label">${label}:</span>${v}`;
        grid.appendChild(d);
      }
    });
    secEl.style.display=grid.children.length?'block':'none';
  }
  ['input','change'].forEach(evt=>form.addEventListener(evt,updateSummary));

  // --- Toggle campos dependentes ---
  document.querySelectorAll('.toggle-dependent').forEach(sel=>{
    const dependents = document.querySelectorAll(sel.dataset.target);
    function toggle(){
      const ok = sel.value==='yes';
      dependents.forEach(el=>{
        el.style.display = ok?'block':'none';
        el.querySelectorAll('input,select').forEach(child=>{
          child.disabled = !ok;
          if(!ok) child.value='';
        });
      });
      updateSummary();
    }
    sel.addEventListener('change',toggle);
    toggle();
  });

  // --- Masks: telefone, CPF, CEP+ViaCEP ---
  const maskMap = [
    { name:'telefone', fn: v=>{v=v.replace(/\D/g,'').slice(0,11); if(v.length>2){const d=v.slice(0,2),n=v.slice(2); if(n.length>8) v=`(${d}) ${n.slice(0,5)}-${n.slice(5)}`; else if(n.length>4) v=`(${d}) ${n.slice(0,4)}-${n.slice(4)}`; else v=`(${d}) ${n}`;} return v; } },
    { name:'cpf', fn: v=>{v=v.replace(/\D/g,'').slice(0,11); if(v.length>9) v=v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/,'$1.$2.$3-$4'); else if(v.length>6) v=v.replace(/(\d{3})(\d{3})(\d{0,3})/,'$1.$2.$3'); else if(v.length>3) v=v.replace(/(\d{3})(\d{0,3})/,'$1.$2'); return v;} },
    { name:'cep', fn: async v=>{v=v.replace(/\D/g,'').slice(0,8); if(v.length>5) v=v.replace(/(\d{5})(\d{0,3})/,'$1-$2'); document.getElementById('cep').value=v; if(v.replace('-','').length===8){ try{const r=await fetch(`https://viacep.com.br/ws/${v.replace('-','')}/json/`); const d=await r.json(); if(!d.erro){document.getElementById('rua').value=d.logradouro||''; document.getElementById('bairro').value=d.bairro||''; document.getElementById('cidade').value=d.localidade||'';} }catch{} } updateSummary(); return null;} }
  ];
  maskMap.forEach(({name,fn})=>{
    const el = form.querySelector(`input[name="${name}"]`);
    if(!el) return;
    if(name!=='cep'){
      el.addEventListener('input', ()=> el.value = fn(el.value));
    } else {
      el.addEventListener('input', ()=> el.value = fn(el.value));
      el.addEventListener('blur', ()=> fn(el.value));
    }
  });

  // --- Clamp num√©rico & ajustes ---
  ['paleto','camisa','calca','numero','sapato_numero','paleto_mg','camisa_mg','calca_cp','calca_perna']
    .forEach(n=>{
      const el = form.querySelector(`[name="${n}"]`);
      if(!el) return;
      el.addEventListener('input', ()=>{
        let x=parseFloat(el.value);
        if(!isNaN(x)){ if(x>200)x=200; if(x<0)x=0; el.value=x; }
      });
    });
  [['paleto_ajuste_cm','paleto','paleto_ajuste'], ['camisa_ajuste_cm','camisa','camisa_ajuste'], ['calca_ajuste_cm','calca','calca_ajuste']]
    .forEach(([adj,base,tgl])=>{
      const adjEl = form.querySelector(`[name="${adj}"]`);
      const baseEl= form.querySelector(`[name="${base}"]`);
      const tglEl = form.querySelector(`[name="${tgl}"]`);
      if(!adjEl||!baseEl||!tglEl) return;
      const wrap = adjEl.closest('.dependent-field');
      function upd(){
        const bv=parseFloat(baseEl.value);
        if(tglEl.value==='yes'&& !isNaN(bv)){
          wrap.style.display='block'; adjEl.disabled=false; adjEl.max=bv;
        } else {
          wrap.style.display='none'; adjEl.disabled=true; adjEl.value='';
        }
      }
      tglEl.addEventListener('change',upd);
      baseEl.addEventListener('input',upd);
      adjEl.addEventListener('input',()=>{ if(parseFloat(adjEl.value)>parseFloat(adjEl.max)) adjEl.value=adjEl.max; });
      upd();
    });

  // --- L√≥gica de pagamento ---
  const totalEl = form.querySelector('input[name="valor_total"]');
  const sinalEl = form.querySelector('input[name="valor_sinal"]');
  const restEl  = form.querySelector('input[name="valor_restante"]');
  [totalEl,sinalEl].forEach(el=>{
    el.addEventListener('input', ()=>{
      el.value = el.value.replace(/[^0-9.]/g,'').replace(/^(\d+)\.(\d{0,2}).*$/,'$1.$2');
      const t=parseFloat(totalEl.value), s=parseFloat(sinalEl.value);
      restEl.value = !isNaN(t)? (isNaN(s)? t.toFixed(2): (t-s).toFixed(2)) : '';
    });
    el.addEventListener('blur', ()=>{
      const t=parseFloat(totalEl.value)||0, s=Math.min(Math.max(parseFloat(sinalEl.value)||0,0),t);
      sinalEl.value = s.toFixed(2);
      restEl.value  = (t-s).toFixed(2);
    });
  });
  restEl.readOnly = true;

  // --- Carrega cores ---
  fetch("{% url 'list_colors' %}")
    .then(r=> r.ok? r.json(): Promise.reject())
    .then(data=>{
      const cores = Array.isArray(data)? data : (data.colors||data.results||[]);
      const opts = `<option value="">--</option>` + cores.map(c=>{
        const desc = c.description||c.descricao||c.name||c.pk;
        return `<option value="${desc}">${desc}</option>`;
      }).join('');
      document.querySelectorAll('.color-select').forEach(s=> s.innerHTML=opts);
    })
    .catch(console.error);

  // --- Submit como JSON ---
  form.addEventListener('submit', async e => {
    e.preventDefault();
    // valida√ß√µes m√≠nimas
    const required = ['cliente_nome','telefone','cpf','paleto','cor_paleto','paleto_mg','camisa','cor_camisa','camisa_mg','calca','cor_calca','calca_cp','calca_perna','forma_pagamento','valor_total','valor_sinal'];
    const missing = required.filter(n=> !form.querySelector(`[name="${n}"]`).value);
    if(missing.length){
      toastEl.querySelector('.toast-body').innerHTML = `<strong>Campos faltando:</strong><ul>${[...new Set(missing)].map(x=>`<li>${x}</li>`).join('')}</ul>`;
      toast.show();
      return;
    }

    const fd = new FormData(form);
    const payload = {
      order_id:           orderId,
      cliente: {
        nome:      fd.get('cliente_nome'),
        cpf:       fd.get('cpf'),
        telefone:  fd.get('telefone'),
        cep:       fd.get('cep'),
        rua:       fd.get('rua'),
        numero:    fd.get('numero'),
        bairro:    fd.get('bairro'),
        cidade:    fd.get('cidade'),
      },
      payment_method:     fd.get('forma_pagamento'),
      total_value:        parseFloat(fd.get('valor_total')),
      advance_payment:    parseFloat(fd.get('valor_sinal')),
      remaining_payment:  parseFloat(fd.get('valor_restante')),
      observations:       '',
      items:              []
    };

    // Fun√ß√£o gen√©rica adiciona todos os campos, incluindo brand/fabric
    function addItem(type, map){
      const obj = { product_type: type };
      let has=false;
      Object.entries(map).forEach(([k,fld])=>{
        let v = fld? fd.get(fld): null;
        if(k==='color'&&fld){
          const sel = form.querySelector(`[name="${fld}"]`);
          v = sel?.options[sel.selectedIndex]?.text||'';
        }
        if(v){ obj[k] = (k==='adjustment_value'? parseFloat(v): v); has=true; }
      });
      if(!has) return;
      payload.items.push({
        ...obj,
        sleeve_length:    obj.sleeve_length   || null,
        leg_length:       obj.leg_length      || null,
        waist_size:       obj.waist_size      || null,
        collar_size:      obj.collar_size     || null,
        color:            obj.color           || null,
        brand:            obj.brand           || null,
        fabric:           obj.fabric          || null,
        description:      obj.description     || '',
        adjustment_needed: fd.get(map.ajuste_flag)==='yes',
        adjustment_value:  obj.adjustment_value|| null,
        adjustment_notes:  obj.description     || ''
      });
    }

    // mapeamento com marca e tecido do terno
    addItem('Paleto', {
      size:             'paleto',
      sleeve_length:    'paleto_mg',
      color:            'cor_paleto',
      brand:            'terno_marca',
      fabric:           'terno_tecido',
      description:      'paleto_ajustes_adicionais',
      ajuste_flag:      'paleto_ajuste',
      adjustment_value: 'paleto_ajuste_cm'
    });
    addItem('Camisa', {
      size:             'camisa',
      sleeve_length:    'camisa_mg',
      color:            'cor_camisa',
      brand:            'camisa_marca',
      fabric:           null,
      description:      'camisa_ajustes_adicionais',
      ajuste_flag:      'camisa_ajuste',
      adjustment_value: 'camisa_ajuste_cm'
    });
    addItem('Calca', {
      size:             'calca',
      leg_length:       'calca_perna',
      waist_size:       'calca_cp',
      color:            'cor_calca',
      brand:            null,
      fabric:           null,
      description:      'calca_ajustes_adicionais',
      ajuste_flag:      'calca_ajuste',
      adjustment_value: 'calca_ajuste_cm'
    });
    // acess√≥rios extra‚Ä¶
    if(fd.get('suspensorio_sim')==='yes') payload.items.push({ product_type:'Suspensorio', color:fd.get('suspensorio_cor'), adjustment_needed:false });
    if(fd.get('lenco_sim')==='yes')       payload.items.push({ product_type:'Lenco',       color:fd.get('lenco_cor'),       adjustment_needed:false });
    if(fd.get('passante_sim')==='yes')    payload.items.push({ product_type:'Cinto',       color:fd.get('passante_cor'),    adjustment_needed:false });
    if(fd.get('sapato_sim')==='yes')      payload.items.push({ product_type:'Sapato',      size:fd.get('sapato_numero'), description:fd.get('sapato_tipo'), adjustment_needed:false });

    // envia para o backend
    try {
      const res = await fetch("{% url 'update_service_order' %}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || 'Erro ao salvar OS');
      alert(`‚úÖ OS atualizada com sucesso! ID: ${json.order_id}`);
      location.reload();
    } catch (err) {
      toastEl.querySelector('.toast-body').textContent = err.message;
      toast.show();
    }
  });

  // inicializa
  showStep(1);
  updateSummary();

  // --- AG-Grid de demonstra√ß√£o (opcional) ---
  const gridDiv = document.getElementById('osGrid');
  if(gridDiv){
    gridDiv.style.height='400px';
    new agGrid.Grid(gridDiv, {
      columnDefs:[ /* ... */ ],
      rowData:  [ /* ... */ ],
      defaultColDef:{ sortable:true, filter:true, resizable:true },
      pagination:true, paginationPageSize:10
    });
  }
});
</script>

{% endblock %}
