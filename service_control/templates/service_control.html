{% extends "base_auth.html" %}
{% load static %}

{% block title %}Ordens de Serviço{% endblock title %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-quartz.css" rel="stylesheet">

<style>
  .form-select, .form-control {
    background-color: var(--input-bg-color);
    color: var(--text-color);
    border: 1px solid var(--modal-border-color);
  }

  label {
    font-weight: bold;
  }

  .card {
    border: 1px solid rgb(189, 189, 189);
    padding-top: 50px;
    transition: 0.5s;
    margin-top: 10px;
    padding: 15px;
    display: flex;
    box-shadow: 1px 1px 5px 0px #9c9c9c;
    border-radius: 15px;
    width: 520px;
    justify-content: center;
    position: relative;
    background-color: var(--bg-color);
  }

  .cliente-info, .contrato-info {
    display: flex;
    flex-direction: column;
    margin-left: 10px;
  }

  .cliente-info p, .contrato-info p {
    font-size: 13px;
    margin: 5px 0;
    color: var(--text-color);
  }

  .saldos {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 7px;
    margin-top: 15px;
    background-color: var(--card-bg-color);
    border-radius: 15px;
    padding: 10px;
    width: 100%;
  }
</style>
{% endblock extra_head %}

{% block content %}
<div class="container mt-4">
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-coreui-toggle="tab" data-coreui-target="#cadastro" type="button">Cadastrar OS</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-coreui-toggle="tab" data-coreui-target="#listagem" type="button">Listar OS</button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Aba de Cadastro -->
    <div class="tab-pane fade show active" id="cadastro" role="tabpanel">
      <form method="POST">
        {% csrf_token %}
        <div class="row mb-3">
          <div class="col-md-6">
            <label>Nome do Cliente</label>
            <input type="text" name="cliente_nome" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label>Telefone</label>
            <input type="text" name="telefone" class="form-control">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label>Data do Evento</label>
            <input type="date" name="data_evento" class="form-control">
          </div>
          <div class="col-md-6">
            <label>Data da Retirada</label>
            <input type="date" name="data_retirada" class="form-control">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label>Data de Devolução</label>
            <input type="date" name="data_devolucao" class="form-control">
          </div>
          <div class="col-md-6">
            <label>Evento</label>
            <input type="text" name="evento" class="form-control">
          </div>
        </div>

        <hr>
        <h5>Itens do Traje</h5>

        <div class="row mb-3">
          <div class="col-md-6">
            <label>Paletó Nº</label>
            <input type="text" name="paleto" class="form-control">
          </div>
          <div class="col-md-6">
            <label>Cor do Paletó</label>
            <select name="cor_paleto" class="form-select color-select" required></select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label>Camisa Nº</label>
            <input type="text" name="camisa" class="form-control">
          </div>
          <div class="col-md-6">
            <label>Cor da Camisa</label>
            <select name="cor_camisa" class="form-select color-select" required></select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label>Calça Nº</label>
            <input type="text" name="calca" class="form-control">
          </div>
          <div class="col-md-6">
            <label>Cor da Calça</label>
            <select name="cor_calca" class="form-select color-select" required></select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label>Sapato Nº</label>
            <input type="text" name="sapato" class="form-control">
          </div>
          <div class="col-md-4">
            <label>Gravata</label>
            <input type="text" name="gravata" class="form-control">
          </div>
          <div class="col-md-4">
            <label>Coletes / Suspensórios</label>
            <input type="text" name="colete" class="form-control">
          </div>
        </div>

        <hr>
        <h5>Pagamento</h5>

        <div class="row mb-3">
          <div class="col-md-4">
            <label>Valor Total</label>
            <input type="number" step="0.01" name="valor_total" class="form-control">
          </div>
          <div class="col-md-4">
            <label>Valor Sinalizado</label>
            <input type="number" step="0.01" name="valor_sinal" class="form-control">
          </div>
          <div class="col-md-4">
            <label>Valor Restante</label>
            <input type="number" step="0.01" name="valor_restante" class="form-control">
          </div>
        </div>

        <button class="btn btn-primary" type="submit">Salvar OS</button>
      </form>
    </div>

    <!-- Aba de Listagem -->
    <div class="tab-pane fade" id="listagem" role="tabpanel">
      <div class="wrapper mt-4">
        <div class="card">
          <h2>OS: #00012</h2>
          <div class="cliente-info">
            <p><strong>Cliente:</strong> Vinícius</p>
            <p><strong>Telefone:</strong> (34) 99999-9999</p>
            <p><strong>Retirada:</strong> 17/04/2025</p>
            <p><strong>Devolução:</strong> 20/05/2025</p>
            <p><strong>Status:</strong> Em andamento</p>
          </div>
          <div class="saldos">
            <p>Valor Total: <span>R$ 130,00</span></p>
            <p>Valor Sinal: <span>R$ 50,00</span></p>
            <p>Valor Restante: <span>R$ 80,00</span></p>
            <p>Atendente: <span>MT</span></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Mantém aba ativa
    const savedTab = localStorage.getItem("activeTab");
    if (savedTab) {
      const triggerEl = document.querySelector(`[data-coreui-target="${savedTab}"]`);
      if (triggerEl) new coreui.Tab(triggerEl).show();
    }

    document.querySelectorAll('[data-coreui-toggle="tab"]').forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-coreui-target");
        localStorage.setItem("activeTab", target);
      });
    });

    // Preenche todos os selects de cor
    fetch("{% url 'list_colors' %}")
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        document.querySelectorAll(".color-select").forEach(select => {
          select.innerHTML = '<option value="">Selecione uma cor</option>';
          data.forEach(item => {
            const option = document.createElement("option");
            option.value = item.id;
            option.textContent = item.description;
            select.appendChild(option);
          });
        });
      })
      .catch(error => {
        console.error("Erro ao carregar cores:", error);
        document.querySelectorAll(".color-select").forEach(select => {
          select.innerHTML = '<option value="">Erro ao carregar</option>';
        });
      });
  });
</script>
{% endblock extra_scripts %}
