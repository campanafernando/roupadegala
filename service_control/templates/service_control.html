{% extends "base_auth.html" %}
{% load static %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root {
    --primary: #0069d9;
    --light-bg: #f8f9fa;
    --card-bg: #ffffff;
    --border: #dee2e6;
    --text: #212529;
    --danger: #dc3545;
  }
  body {
    background: var(--light-bg);
    color: var(--text);
  }
  .d-flex.main { gap: 1rem; }

  .main.summary-collapsed .summary-sidebar {
    width: 0;
    opacity: 0;
    pointer-events: none;
  }
  .main.summary-collapsed .form-container {
    max-width: 100% !important;
  }


  /* 1) Formul√°rio maior: subtra√≠mos agora 600px (tamanho da sidebar) */
  .form-container {
    flex-grow: 1;
    max-width: calc(100% - 600px);
    transition: max-width .3s ease;
  }
  .list-mode .form-container {
    max-width: 100% !important;
  }

  /* 2) Sidebar de resumo tamb√©m ajustada para 600px */
  .summary-sidebar {
    width: 600px;
    flex-shrink: 0;
    background: var(--card-bg);
    border-left: 2px solid var(--primary);
    padding: 1rem;
    max-height: 90vh;
    overflow-y: auto;
    transition: opacity .3s ease, width .3s ease;
  }
  .list-mode .summary-sidebar {
    opacity: 0;
    width: 0;
    pointer-events: none;
  }

  /* 3) Campos ‚ÄúCor‚Äù (e todo col-md-2) um pouco mais largos em telas m√©dias para evitar estouro */
  @media (min-width: 768px) {
    .form-container .col-md-2 {
      flex: 0 0 18%;
      max-width: 18%;
    }
  }

  .form-control, .form-select {
    padding: .75rem .75rem;
  }

  /* Stepper */
  .stepper {
    display: flex;
    justify-content: space-between;
    margin: 2rem 0;
    position: relative;
  }
  {% comment %} .stepper::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 2rem;
    right: 2rem;
    height: 2px;
    background: var(--border);
    z-index: 0;
  } {% endcomment %}
  .step {
    position: relative;
    z-index: 1;
    text-align: center;
    flex: 1;
  }
  .step-circle {
    display: inline-block;
    width: 2.5rem;
    height: 2.5rem;
    line-height: 2.5rem;
    border-radius: 50%;
    border: 2px solid var(--border);
    background: var(--card-bg);
    transition: .3s;
  }
  .step-label {
    margin-top: .3rem;
    font-size: .9rem;
    display: block;
  }
  .step.active .step-circle,
  .step.completed .step-circle {
    background: var(--primary);
    border-color: var(--primary);
    color: #fff;
  }
  .step.active .step-label,
  .step.completed .step-label {
    color: var(--primary);
  }

  /* Form steps */
  .form-step {
    display: none;
    animation: fadeIn .3s;
  }
  .form-step.active { display: block; }
  @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }

  /* Resumo */
  .summary-sidebar h5 {
    color: var(--primary);
    margin-bottom: 1rem;
    font-weight: 600;
  }
  .summary-section {
    margin-bottom: 1.5rem;
    display: none;
  }
  .summary-section h6 {
    margin-bottom: .5rem;
    font-weight: 600;
    font-size: 1rem;
    color: var(--primary);
  }
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* cada cart√£o m√≠nimo de 160px */
    gap: .5rem;
  }
  .summary-item {
    background: var(--light-bg);
    border: 1px solid var(--border);
    border-radius: .25rem;
    padding: .4rem .6rem;
    font-size: .85rem;
  }
  .summary-item .label {
    font-weight: 600;
    margin-right: .25rem;
  }

  /* Erros em toast */
  .toast-body ul {
    margin: 0;
    padding-left: 1rem;
  }
</style>
{% endblock %}


{% block content %}
<div class="container my-4">
  <button id="toggleSummary" class="btn btn-outline-secondary mb-3">
    <i class="bi bi-list"></i> Mostrar/ocultar Resumo
  </button>

  <div class="d-flex main">

    <!-- Form -->
    <div class="form-container">
      <div class="card shadow-sm">
        <div class="card-body">

          {% comment %} <!-- Tabs -->
          <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
              <button class="nav-link active" data-coreui-toggle="tab" data-coreui-target="#cadastro">üìù Cadastrar OS</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-coreui-toggle="tab" data-coreui-target="#listagem">üìã Listar OS</button>
            </li>
          </ul> {% endcomment %}

          <div class="tab-content">

            <!-- Cadastro OS -->
            <div class="tab-pane fade show active" id="cadastro">

              <!-- Stepper -->
              <div class="stepper">
                <div class="step active" data-step="1">
                  <span class="step-circle"><i class="bi bi-person"></i></span>
                  <span class="step-label">Cliente</span>
                </div>
                <div class="step" data-step="2">
                  <span class="step-circle"><i class="bi bi-suit-club-fill"></i></span>
                  <span class="step-label">Terno</span>
                </div>
                <div class="step" data-step="3">
                  <span class="step-circle"><i class="bi bi-person-hearts"></i></span>
                  <span class="step-label">Camisa</span>
                </div>
                <div class="step" data-step="4">
                  <span class="step-circle"><i class="bi bi-gem"></i></span>
                  <span class="step-label">Acess√≥rios</span>
                </div>
                <div class="step" data-step="5">
                  <span class="step-circle"><i class="bi bi-cash-coin"></i></span>
                  <span class="step-label">Pagamento</span>
                </div>
              </div>

              <form id="osForm" novalidate>
                {% csrf_token %}

                <!-- STEP 1: Cliente -->
                <div class="form-step active" data-step="1">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Nome *</label>
                      <input id="cliente_nome" name="cliente_nome" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Telefone *</label>
                      <input id="telefone"   name="telefone" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">CPF *</label>
                      <input id="cpf" name="cpf" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">CEP</label>
                      <input id="cep" name="cep" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Rua</label>
                      <input id="rua" name="rua" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">N√∫mero</label>
                      <input id="numero" name="numero" type="number" class="form-control" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Bairro</label>
                      <input id="bairro" name="bairro" type="text" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Cidade</label>
                      <input id="cidade" name="cidade" type="text" class="form-control" readonly>
                    </div>
                  </div>
                  <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 2: Terno -->
                <div class="form-step" data-step="2">
                  <div class="row g-3">
                    <!-- Linha 1: Marca e Tecido -->
                    <div class="col-md-6">
                      <label class="form-label">Marca do Terno *</label>
                      <input name="terno_marca" type="text" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Tecido do Terno *</label>
                      <input name="terno_tecido" type="text" class="form-control" required>
                    </div>

                    <!-- Linha 2: Palet√≥ -->
                    <div class="col-md-2">
                      <label class="form-label">N¬∫ Palet√≥ *</label>
                      <input name="paleto" type="number" class="form-control" min="0" max="200" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Cor Palet√≥ *</label>
                      <select name="cor_paleto" class="form-select color-select" required></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Manga Palet√≥ *</label>
                      <input name="paleto_mg" type="number" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Ajuste Palet√≥?</label>
                      <select name="paleto_ajuste" class="form-select toggle-dependent" data-target=".paleto-ajuste">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 paleto-ajuste dependent-field" style="display:none">
                      <label class="form-label">Ajuste Palet√≥ (cm)</label>
                      <input name="paleto_ajuste_cm" type="number" step="0.5" class="form-control" disabled>
                    </div>

                    <!-- Linha 3: Colete -->
                    <div class="col-md-2">
                      <label class="form-label">Colete?</label>
                      <select name="colete_presente" class="form-select toggle-dependent" data-target=".colete-cor">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 colete-cor dependent-field" style="display:none">
                      <label class="form-label">Cor do Colete</label>
                      <select name="cor_colete" class="form-select color-select" disabled></select>
                    </div>

                    <!-- Linha 4: Cal√ßa -->
                    <div class="col-md-2">
                      <label class="form-label">N¬∫ Cal√ßa *</label>
                      <input name="calca" type="number" class="form-control" min="0" max="200" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Cor Cal√ßa *</label>
                      <select name="cor_calca" class="form-select color-select" required></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Cintura Cal√ßa *</label>
                      <input name="calca_cp" type="number" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Perna Cal√ßa *</label>
                      <input name="calca_perna" type="number" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Ajuste Cal√ßa?</label>
                      <select name="calca_ajuste" class="form-select toggle-dependent" data-target=".calca-ajuste">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 calca-ajuste dependent-field" style="display:none">
                      <label class="form-label">Ajuste Cal√ßa (cm)</label>
                      <input name="calca_ajuste_cm" type="number" step="0.5" class="form-control" disabled>
                    </div>
                  </div>

                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 3: Camisa -->
                <div class="form-step" data-step="3">
                  <div class="row g-3">
                    <div class="col-md-2">
                      <label class="form-label">N¬∫ *</label>
                      <input name="camisa" type="number" class="form-control" min="0" max="200" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Cor *</label>
                      <select name="cor_camisa" class="form-select color-select" required></select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Manga *</label>
                      <input name="camisa_mg" type="number" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Marca *</label>
                      <input name="camisa_marca" type="text" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Ajuste?</label>
                      <select name="camisa_ajuste" class="form-select toggle-dependent" data-target=".camisa-ajuste">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 camisa-ajuste dependent-field" style="display:none">
                      <label class="form-label">Ajuste (cm)</label>
                      <input name="camisa_ajuste_cm" type="number" step="0.5" class="form-control" disabled>
                    </div>
                    {% comment %} <div class="col-md-4">
                      <label class="form-label">Extras</label>
                      <input name="camisa_ajustes_adicionais" type="text" class="form-control">
                    </div> {% endcomment %}
                  </div>

                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 5: Acess√≥rios -->
                <div class="form-step" data-step="4">
                  <div class="row g-3">
                    <div class="col-md-2">
                      <label class="form-label">Suspens√≥rio?</label>
                      <select name="suspensorio_sim" class="form-select toggle-dependent" data-target=".suspensorio-info">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 suspensorio-info dependent-field" style="display:none">
                      <label class="form-label">Cor</label>
                      <select name="suspensorio_cor" class="form-select color-select"></select>
                    </div>

                    <div class="col-md-2">
                      <label class="form-label">Len√ßo?</label>
                      <select name="lenco_sim" class="form-select toggle-dependent" data-target=".lenco-info">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 lenco-info dependent-field" style="display:none">
                      <label class="form-label">Cor</label>
                      <select name="lenco_cor" class="form-select color-select"></select>
                    </div>

                    <div class="col-md-2">
                      <label class="form-label">Passante?</label>
                      <select name="passante_sim" class="form-select toggle-dependent" data-target=".passante-info">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 passante-info dependent-field" style="display:none">
                      <label class="form-label">Cor</label>
                      <select name="passante_cor" class="form-select color-select"></select>
                    </div>

                    <div class="col-md-2">
                      <label class="form-label">Sapato?</label>
                      <select name="sapato_sim" class="form-select toggle-dependent" data-target=".sapato-info">
                        <option value="">--</option>
                        <option value="yes">Sim</option>
                        <option value="no">N√£o</option>
                      </select>
                    </div>
                    <div class="col-md-2 sapato-info dependent-field" style="display:none">
                      <label class="form-label">Tipo</label>
                      <input name="sapato_tipo" type="text" class="form-control">
                    </div>
                    <div class="col-md-2 sapato-info dependent-field" style="display:none">
                      <label class="form-label">N¬∫</label>
                      <input name="sapato_numero" type="number" class="form-control" min="0" max="200">
                    </div>
                  </div>
                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 6: Pagamento -->
                <div class="form-step" data-step="5">
                  <div class="row g-3">
                    {% comment %} <div class="col-md-4">
                      <label class="form-label">Data do Pedido *</label>
                      <input name="order_date" type="date" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Data do Evento *</label>
                      <input name="event_date" type="date" class="form-control" required>
                    </div> {% endcomment %}
                    <div class="col-md-4">
                      <label class="form-label">Forma de Pagamento *</label>
                      <select name="forma_pagamento" class="form-select" required>
                        <option value="">Selecione...</option>
                        <option value="CREDITO">CR√âDITO</option>
                        <option value="DEBITO">D√âBITO</option>
                        <option value="PIX">PIX</option>
                        <option value="DINHEIRO">DINHEIRO</option>
                        <option value="CHEQUE">CHEQUE</option>
                      </select>
                    </div>
                    {% comment %} <div class="col-md-3">
                      <label class="form-label">Tipo *</label>
                      <select name="purchase" class="form-select" required>
                        <option value="false" selected>Loca√ß√£o</option>
                        <option value="true">Compra</option>
                      </select>
                    </div> {% endcomment %}
                  </div>
                  <div class="row g-3 mt-3">
                    <div class="col-md-4">
                      <label class="form-label">Total (R$) *</label>
                      <input name="valor_total" type="text" class="form-control" placeholder="0.00" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Sinal (R$) *</label>
                      <input name="valor_sinal" type="text" class="form-control" placeholder="0.00" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Restante (R$)</label>
                      <input name="valor_restante" type="text" class="form-control" placeholder="0.00" readonly>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="submit" class="btn btn-success">Salvar OS</button>
                  </div>
                </div>

              </form>

            </div>

            {% comment %} <!-- Listagem -->
            <div class="tab-pane fade" id="listagem">
              <div id="osGrid" class="ag-theme-quartz"></div>
            </div> {% endcomment %}

            {% comment %} <div class="tab-pane fade" id="listagem">
              <div class="row g-4">
                {% for os in ordens %}
                  <div class="col-md-4">
                    <div class="card h-100">
                      <div class="card-header">OS #{{ os.id }}</div>
                      <div class="card-body">
                        <p><strong>Cliente:</strong> {{ os.renter.name }}</p>
                        <p><strong>Telefone:</strong> {{ os.renter.personscontacts.first.phone }}</p>
                        <hr>
                        <p><strong>Total:</strong> R$ {{ os.total_value }}</p>
                        <p><strong>Sinal:</strong> R$ {{ os.advance_payment }}</p>
                        <p><strong>Restante:</strong> R$ {{ os.remaining_payment }}</p>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div class="col-12 text-center text-muted">Nenhuma ordem cadastrada.</div>
                {% endfor %}
              </div>
            </div> {% endcomment %}

          </div>
        </div>
      </div>
    </div>

    <!-- Summary Sidebar -->
    <div class="summary-sidebar">
      <h5><i class="bi bi-clipboard-check me-1"></i>Resumo</h5>
      <div id="liveSummary">
        <div class="summary-section" data-section="Cliente">
          <h6><i class="bi bi-person-fill me-1"></i>Cliente</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Terno">
          <h6><i class="bi bi-suit-club-fill me-1"></i>Terno</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Camisa">
          <h6><i class="bi bi-person-hearts"></i>Camisa</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Acess√≥rios">
          <h6><i class="bi bi-gem me-1"></i>Acess√≥rios</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Pagamento">
          <h6><i class="bi bi-cash-coin me-1"></i>Pagamento</h6>
          <div class="summary-grid"></div>
        </div>
      </div>
    </div>


  </div>
</div>

<!-- Error Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1100;">
  <div id="errorToast" class="toast align-items-center border border-danger" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body text-danger"></div>
      <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ID da OS vindo do contexto Django
  const osId = {{ order_id }};
  fetch(`/os/${osId}/cliente/`, {
    credentials: 'same-origin',
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(res => {
    if (!res.ok) throw new Error('N√£o foi poss√≠vel carregar dados do cliente');
    return res.json();
  })
  .then(({ data }) => {
    // preenche campos
    document.getElementById('cliente_nome').value = data.nome || '';
    document.getElementById('cpf').value          = data.cpf  || '';
    document.getElementById('telefone').value     = data.telefones[0] || '';
    // se houver endere√ßos, preenche o primeiro
    if (data.enderecos && data.enderecos.length) {
      const addr = data.enderecos[0];
      document.getElementById('cep').value    = addr.cep      || '';
      document.getElementById('rua').value    = addr.rua      || '';
      document.getElementById('numero').value = addr.numero   || '';
      document.getElementById('bairro').value = addr.bairro   || '';
      document.getElementById('cidade').value = addr.cidade   || '';
    }
  })
  .catch(err => {
    console.error(err);
    // opcional: exibir mensagem de erro na UI
  });
});

document.addEventListener('DOMContentLoaded', () => {
  const mainEl       = document.querySelector('.d-flex.main');
  const toggleBtn    = document.getElementById('toggleSummary');

  // === (3) Toggle de colapsar/expandir ===
  toggleBtn.addEventListener('click', () => {
    mainEl.classList.toggle('summary-collapsed');
  });
  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      document.cookie.split(';').forEach(c => {
        c = c.trim();
        if (c.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(c.slice(name.length + 1));
        }
      });
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Stepper navigation
  const steps = document.querySelectorAll('.step');
  const forms = document.querySelectorAll('.form-step');
  const form  = document.getElementById('osForm');
  const toastEl = document.getElementById('errorToast');
  const toast = new bootstrap.Toast(toastEl);
  let current = 1;
  function showStep(n) {
    forms.forEach(f => f.classList.toggle('active', +f.dataset.step === n));
    steps.forEach(s => {
      const idx = +s.dataset.step;
      s.classList.toggle('active', idx === n);
      s.classList.toggle('completed', idx < n);
    });
    current = n;
  }
  document.querySelectorAll('[data-action=next]').forEach(btn =>
    btn.addEventListener('click', () => current < forms.length && showStep(current + 1))
  );
  document.querySelectorAll('[data-action=prev]').forEach(btn =>
    btn.addEventListener('click', () => current > 1 && showStep(current - 1))
  );
  form.addEventListener('keydown', e => {
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
  });
  document.querySelectorAll('[data-coreui-toggle="tab"]').forEach(link =>
    link.addEventListener('click', () => {
      document.body.classList.toggle('list-mode', link.getAttribute('data-coreui-target') === '#listagem');
    })
  );

  // Summary builder
  const itemGroups = [
    ['Palet√≥', [
      ['paleto','N¬∫'],['cor_paleto','Cor Palet√≥'],['paleto_mg','Manga'],
      ['paleto_ajuste_cm','Ajuste', f => f.get('paleto_ajuste') === 'yes'],
      ['paleto_ajustes_adicionais','Extras']
    ]],
    ['Camisa', [
      ['camisa','N¬∫'],['cor_camisa','Cor Camisa'],['camisa_mg','Manga'],
      ['camisa_ajuste_cm','Ajuste', f => f.get('camisa_ajuste') === 'yes'],
      ['camisa_ajustes_adicionais','Extras']
    ]],
    ['Cal√ßa', [
      ['calca','N¬∫'],['cor_calca','Cor Cal√ßa'],['calca_cp','Cintura'],
      ['calca_perna','Perna'],['calca_ajuste_cm','Ajuste', f => f.get('calca_ajuste') === 'yes'],
      ['calca_ajustes_adicionais','Extras']
    ]]
  ];

  const schema = {
    'Cliente': [
      ['cliente_nome','Nome'],['telefone','Telefone'],['cpf','CPF'],
      ['rua','Rua'],['numero','N√∫mero'],['bairro','Bairro'],['cidade','Cidade']
    ],
    'Acess√≥rios': [
      ['suspensorio_sim','Suspens√≥rio'],['suspensorio_cor','Cor Suspens√≥rio', f => f.get('suspensorio_sim') === 'yes'],
      ['lenco_sim','Len√ßo'],['lenco_cor','Cor Len√ßo', f => f.get('lenco_sim') === 'yes'],
      ['passante_sim','Passante'],['passante_cor','Cor Passante', f => f.get('passante_sim') === 'yes'],
      ['sapato_sim','Sapato'],['sapato_tipo','Tipo', f => f.get('sapato_sim') === 'yes'],
      ['sapato_numero','N¬∫', f => f.get('sapato_sim') === 'yes']
    ],
    'Camisa': [
      ['camisa','N¬∫'],['cor_camisa','Cor'],['camisa_mg','Manga'],
      ['camisa_ajuste_cm','Ajuste', f => f.get('camisa_ajuste') === 'yes'],
      ['camisa_ajustes_adicionais','Extras']
    ],
    'Pagamento': [
      ['order_date','Data Pedido'],['event_date','Data Evento'],
      ['occasion','Ocasi√£o'],['purchase','Tipo'],
      ['valor_total','Total'],['valor_sinal','Sinal'],['valor_restante','Restante']
    ]
  };

  function updateSummary() {
    const fd = new FormData(form);

    ['Cliente', 'Terno', 'Camisa', 'Acess√≥rios', 'Pagamento'].forEach(section => {
      const secEl = document.querySelector(`.summary-section[data-section="${section}"]`);
      const grid = secEl.querySelector('.summary-grid');
      grid.innerHTML = '';

      if (section === 'Terno') {
        updateTernoSummary(fd);
        return;
      }

      const fields = schema[section];
      if (!fields) return;

      fields.forEach(([k, label, cond]) => {
        if ((!cond || cond(fd)) && fd.get(k)) {
          let v = fd.get(k);
          const el = form.querySelector(`[name="${k}"]`);
          if (el && el.tagName === 'SELECT') {
            v = el.options[el.selectedIndex]?.text || v;
          }
          const div = document.createElement('div');
          div.className = 'summary-item';
          div.innerHTML = `<span class="label">${label}:</span>${v}`;
          grid.appendChild(div);
        }
      });

      secEl.style.display = grid.children.length ? 'block' : 'none';
    });
  }
  ['input', 'change'].forEach(evt => form.addEventListener(evt, updateSummary));


  // Acess√≥rios: mostrar campos de cor ao selecionar "Sim"
document.querySelectorAll('.toggle-dependent').forEach(sel => {
  const targetCls = sel.dataset.target;
  const dependents = document.querySelectorAll(targetCls);
  function toggleVisibility() {
    const isYes = sel.value === 'yes';
    dependents.forEach(el => {
      el.style.display = isYes ? 'block' : 'none';
      el.querySelectorAll('select,input').forEach(child => {
        child.disabled = !isYes;
        if (!isYes) child.value = ''; // limpa valor se marcado como "N√£o"
      });
    });
    updateSummary(); // atualiza resumo imediatamente
  }
  sel.addEventListener('change', toggleVisibility);
  toggleVisibility(); // inicializa visibilidade correta ao carregar
});


  // --- Masks & Validations ---

  // Telefone mask
  const telEl = form.querySelector('input[name="telefone"]');
  telEl.addEventListener('input', () => {
    let v = telEl.value.replace(/\D/g, '').slice(0,11);
    if (v.length > 2) {
      const d = v.slice(0,2), n = v.slice(2);
      if (n.length > 8) v = `(${d}) ${n.slice(0,5)}-${n.slice(5)}`;
      else if (n.length > 4) v = `(${d}) ${n.slice(0,4)}-${n.slice(4)}`;
      else v = `(${d}) ${n}`;
    }
    telEl.value = v;
  });

  // CPF mask
  const cpfEl = form.querySelector('input[name="cpf"]');
  cpfEl.addEventListener('input', () => {
    let v = cpfEl.value.replace(/\D/g, '').slice(0,11);
    if (v.length > 9) v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
    else if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
    else if (v.length > 3) v = v.replace(/(\d{3})(\d{0,3})/, '$1.$2');
    cpfEl.value = v;
  });

  // CEP + ViaCEP
  const cepEl = document.getElementById('cep');
  cepEl.addEventListener('input', () => {
    let v = cepEl.value.replace(/\D/g, '').slice(0,8);
    if (v.length > 5) v = v.replace(/(\d{5})(\d{0,3})/, '$1-$2');
    cepEl.value = v;
  });
  ['blur','input'].forEach(evt => cepEl.addEventListener(evt, async () => {
    const v = cepEl.value.replace(/\D/g,'');
    if (v.length === 8) {
      try {
        const res = await fetch(`https://viacep.com.br/ws/${v}/json/`);
        const data = await res.json();
        if (!data.erro) {
          ['logradouro','bairro','localidade'].forEach((f,i) => {
            const id = ['rua','bairro','cidade'][i];
            document.getElementById(id).value = data[f];
          });
        }
      } catch {}
    } else if (!v) {
      ['rua','bairro','cidade'].forEach(id => document.getElementById(id).value = '');
    }
    updateSummary();
  }));

  // Numeric clamp ‚â§200
  ['paleto','camisa','calca','numero','sapato_numero','paleto_mg','camisa_mg','calca_cp','calca_perna']
    .forEach(name => {
      const el = form.querySelector(`[name="${name}"]`);
      if (!el) return;
      el.addEventListener('input', () => {
        let n = parseFloat(el.value);
        if (!isNaN(n)) {
          if (n > 200) n = 200;
          else if (n < 0) n = 0;
          el.value = n;
        }
      });
    });

  // Ajuste logic
  [
    { adj: 'paleto_ajuste_cm', base: 'paleto', toggle: 'paleto_ajuste' },
    { adj: 'camisa_ajuste_cm', base: 'camisa', toggle: 'camisa_ajuste' },
    { adj: 'calca_ajuste_cm',  base: 'calca',  toggle: 'calca_ajuste'  },
  ].forEach(({adj, base, toggle}) => {
    const adjEl    = form.querySelector(`[name="${adj}"]`);
    const baseEl   = form.querySelector(`[name="${base}"]`);
    const toggleEl = form.querySelector(`[name="${toggle}"]`);
    if (adjEl && baseEl && toggleEl) {
      const wrapper = adjEl.closest('.dependent-field');
      function updateAdjust() {
        const bv = parseFloat(baseEl.value);
        if (toggleEl.value === 'yes' && !isNaN(bv)) {
          wrapper.style.display = 'block';
          adjEl.disabled = false;
          adjEl.max = bv;
        } else {
          wrapper.style.display = 'none';
          adjEl.value = '';
          adjEl.disabled = true;
        }
      }
      toggleEl.addEventListener('change', updateAdjust);
      baseEl.addEventListener('input', updateAdjust);
      adjEl.addEventListener('input', () => {
        const av = parseFloat(adjEl.value), mv = parseFloat(adjEl.max);
        if (!isNaN(av) && !isNaN(mv) && av > mv) {
          adjEl.value = mv;
        }
      });
      updateAdjust();
    }
  }); // ‚úÖ fecha o forEach corretamente aqui


  // Payment logic
  const totalEl = form.querySelector('input[name="valor_total"]');
  const sinalEl = form.querySelector('input[name="valor_sinal"]');
  const restEl  = form.querySelector('input[name="valor_restante"]');
  restEl.readOnly = true;
  function fmtDec(el) {
    let parts = el.value.replace(/[^0-9\.]/g, '').split('.');
    if (parts.length > 2) parts = [parts[0], parts.slice(1).join('')];
    el.value = parts[0] + (parts[1] ? '.' + parts[1].slice(0,2) : '');
  }
  totalEl.addEventListener('input', () => {
    fmtDec(totalEl);
    const t = parseFloat(totalEl.value), s = parseFloat(sinalEl.value);
    restEl.value = !isNaN(t) ? (isNaN(s) ? t.toFixed(2) : (t-s).toFixed(2)) : '';
  });
  sinalEl.addEventListener('input', () => {
    fmtDec(sinalEl);
    const t = parseFloat(totalEl.value), s = parseFloat(sinalEl.value);
    restEl.value = !isNaN(t) ? (isNaN(s) ? t.toFixed(2) : (t-s).toFixed(2)) : '';
  });
  [totalEl, sinalEl].forEach(el =>
    el.addEventListener('blur', () => {
      const t = parseFloat(totalEl.value);
      let s = parseFloat(sinalEl.value);
      if (!isNaN(t)) {
        if (isNaN(s) || s < 0) s = 0;
        if (s > t) s = t;
        sinalEl.value = s.toFixed(2);
        restEl.value  = (t - s).toFixed(2);
      }
    })
  );

  // Load colors
  fetch("{% url 'list_colors' %}")
    .then(r => {
      if (!r.ok) throw new Error('Erro ao buscar lista de cores');
      return r.json();
    })
    .then(data => {
      // data pode ser um array ou um objeto com lista dentro
      const cores = Array.isArray(data) ? data : (data.colors || data.results || []);
      const options = cores.map(c => {
        const id   = c.id ?? c.pk;
        const desc = c.description ?? c.descricao;
        return `<option value="${id}">${desc}</option>`;
      }).join('');
      document.querySelectorAll('.color-select').forEach(sel => {
        sel.innerHTML = '<option value="">--</option>' + options;
      });
    })
    .catch(err => {
      console.error(err);
      // opcional: exibir toast de erro para o usu√°rio
  });

  // Submit as JSON
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const missing = [];
    ['cliente_nome','telefone','cpf','rua','bairro','cidade'].forEach(n => {
      if (!form.querySelector(`[name="${n}"]`).value) missing.push(n);
    });
    ['paleto','cor_paleto','paleto_mg','camisa','cor_camisa','camisa_mg','calca','cor_calca','calca_cp','calca_perna']
      .forEach(n => !form.querySelector(`[name="${n}"]`).value && missing.push(n));
    ['forma_pagamento','valor_total','valor_sinal']
      .forEach(n => !form.querySelector(`[name="${n}"]`).value && missing.push(n));

    if (missing.length) {
      toastEl.querySelector('.toast-body').innerHTML =
        `<strong>Campos faltando:</strong><ul>${[...new Set(missing)].map(x=>`<li>${x}</li>`).join('')}</ul>`;
      toast.show();
      return;
    }

    const fd = new FormData(form);
    const payload = {
      cliente: {
        nome: fd.get('cliente_nome'),
        cpf: fd.get('cpf'),
        telefone: fd.get('telefone'),
        cep: fd.get('cep'),
        rua: fd.get('rua'),
        numero: fd.get('numero'),
        bairro: fd.get('bairro'),
        cidade: fd.get('cidade'),
      },
      forma_pagamento: fd.get('forma_pagamento'),
      total_value: parseFloat(fd.get('valor_total')),
      advance_payment: parseFloat(fd.get('valor_sinal')),
      remaining_payment: parseFloat(fd.get('valor_restante')),
      observations: '',
      items: []
    };

    function addItem(type, map) {
      const obj = { product_type: type };
      let has = false;
      Object.entries(map).forEach(([k, fld]) => {
        const v = fd.get(fld);
        if (v) {
          obj[k] = (k === 'adjustment_value' ? parseFloat(v) : v);
          has = true;
        }
      });
      if (has) {
        payload.items.push({
          ...obj,
          sleeve_length: obj.sleeve_length || null,
          leg_length:    obj.leg_length    || null,
          waist_size:    obj.waist_size    || null,
          collar_size:   obj.collar_size   || null,
          color:         obj.color         || null,
          description:   obj.description   || '',
          adjustment_needed: fd.get(map.ajuste_flag) === 'yes',
          adjustment_value:   obj.adjustment_value || null,
          adjustment_notes:   obj.description   || ''
        });
      }
    }

    addItem('Paleto', {
      size: 'paleto',
      sleeve_length: 'paleto_mg',
      color: 'cor_paleto',
      brand: 'terno_marca',
      fabric: 'terno_tecido',              // üëà novo
      description: 'paleto_ajustes_adicionais',
      ajuste_flag: 'paleto_ajuste',
      adjustment_value: 'paleto_ajuste_cm'
    });
    addItem('Camisa', {
      size: 'camisa',
      sleeve_length: 'camisa_mg',
      color: 'cor_camisa',
      brand: 'camisa_marca',
      fabric: null,  // se n√£o existir tecido para camisa, deixe null
      description: 'camisa_ajustes_adicionais',
      ajuste_flag: 'camisa_ajuste',
      adjustment_value: 'camisa_ajuste_cm'
    });
    addItem('Calca', {
      size: 'calca',
      leg_length: 'calca_perna',
      waist_size: 'calca_cp',
      color: 'cor_calca',
      description: 'calca_ajustes_adicionais',
      ajuste_flag: 'calca_ajuste',
      adjustment_value: 'calca_ajuste_cm'
    });

    if (fd.get('suspensorio_sim') === 'yes') payload.items.push({
      product_type: 'Suspensorio',
      color: fd.get('suspensorio_cor'),
      description: '',
      sleeve_length: null, leg_length: null,
      waist_size: null, collar_size: null,
      adjustment_needed: false,
      adjustment_value: null,
      adjustment_notes: ''
    });
    if (fd.get('lenco_sim') === 'yes') payload.items.push({
      product_type: 'Lenco',
      color: fd.get('lenco_cor'),
      description: '',
      sleeve_length: null, leg_length: null,
      waist_size: null, collar_size: null,
      adjustment_needed: false,
      adjustment_value: null,
      adjustment_notes: ''
    });
    if (fd.get('passante_sim') === 'yes') payload.items.push({
      product_type: 'Cinto',
      color: fd.get('passante_cor'),
      description: '',
      sleeve_length: null, leg_length: null,
      waist_size: null, collar_size: null,
      adjustment_needed: false,
      adjustment_value: null,
      adjustment_notes: ''
    });
    if (fd.get('sapato_sim') === 'yes') payload.items.push({
      product_type: 'Sapato',
      size: fd.get('sapato_numero'),
      description: fd.get('sapato_tipo'),
      color: null,
      sleeve_length: null, leg_length: null,
      waist_size: null, collar_size: null,
      adjustment_needed: false,
      adjustment_value: null,
      adjustment_notes: ''
    });

    try {
      const res = await fetch("{% url 'create_service_order' %}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || 'Erro ao criar OS');
      alert(`‚úÖ OS criada com sucesso! ID: ${json.order_id}`);
      location.reload();
    } catch (err) {
      toastEl.querySelector('.toast-body').textContent = err.message;
      toast.show();
    }
  });

  // Initialize
  showStep(1);
  updateSummary();

  function updateTernoSummary(fd) {
    const section = document.querySelector('.summary-section[data-section="Terno"]');
    const grid = section.querySelector('.summary-grid');
    grid.innerHTML = '';

    const fields = [
      ['terno_marca', 'Marca'],
      ['terno_tecido', 'Tecido'],

      ['paleto', 'Palet√≥ N¬∫'],
      ['cor_paleto', 'Palet√≥ Cor'],
      ['paleto_mg', 'Palet√≥ Manga'],
      ['paleto_ajuste_cm', 'Ajuste Palet√≥', fd => fd.get('paleto_ajuste') === 'yes'],

      ['calca', 'Cal√ßa N¬∫'],
      ['cor_calca', 'Cal√ßa Cor'],
      ['calca_cp', 'Cal√ßa Cintura'],
      ['calca_perna', 'Cal√ßa Perna'],
      ['calca_ajuste_cm', 'Ajuste Cal√ßa', fd => fd.get('calca_ajuste') === 'yes'],

      ['colete_presente', 'Colete'],
      ['cor_colete', 'Cor do Colete', fd => fd.get('colete_presente') === 'yes'],

      ['terno_ajustes_adicionais', 'Ajustes/Obs.']
    ];

    fields.forEach(([key, label, condition]) => {
      if ((!condition || condition(fd)) && fd.get(key)) {
        let val = fd.get(key);
        const el = form.querySelector(`[name="${key}"]`);
        if (el && el.tagName === 'SELECT') {
          val = el.options[el.selectedIndex]?.text || val;
        }
        const div = document.createElement('div');
        div.className = 'summary-item';
        div.innerHTML = `<span class="label">${label}:</span>${val}`;
        grid.appendChild(div);
      }
    });

    section.style.display = grid.children.length ? 'block' : 'none';
  }

// Corrige exibi√ß√£o do campo "camisa_ajuste_cm" e impede valores acima de 200
function fixCamisaAjusteToggle() {
  const toggleEl = form.querySelector('[name="camisa_ajuste"]');
  const ajusteEl = form.querySelector('[name="camisa_ajuste_cm"]');
  const wrapperEl = ajusteEl.closest('.dependent-field');

  function updateField() {
    if (toggleEl.value === 'yes') {
      wrapperEl.style.display = 'block';
      ajusteEl.disabled = false;
      ajusteEl.max = 200;
    } else {
      wrapperEl.style.display = 'none';
      ajusteEl.value = '';
      ajusteEl.disabled = true;
    }
  }

  ajusteEl.addEventListener('input', () => {
    let val = parseFloat(ajusteEl.value);
    if (!isNaN(val) && val > 200) {
      ajusteEl.value = 200;
    }
  });

  toggleEl.addEventListener('change', updateField);
  form.querySelector('[name="camisa"]').addEventListener('input', updateField);

  // inicializa corretamente ao carregar
  updateField();
}

fixCamisaAjusteToggle();


function fixPaletoCalcaAjusteToggle() {
  const ajustes = [
    { ajuste: 'paleto_ajuste', campo: 'paleto_ajuste_cm' },
    { ajuste: 'calca_ajuste', campo: 'calca_ajuste_cm' }
  ];

  ajustes.forEach(({ ajuste, campo }) => {
    const toggleEl = form.querySelector(`[name="${ajuste}"]`);
    const ajusteEl = form.querySelector(`[name="${campo}"]`);
    const wrapperEl = ajusteEl.closest('.dependent-field');

    function updateField() {
      if (toggleEl.value === 'yes') {
        wrapperEl.style.display = 'block';
        ajusteEl.disabled = false;
        ajusteEl.max = 200;
      } else {
        wrapperEl.style.display = 'none';
        ajusteEl.value = '';
        ajusteEl.disabled = true;
      }
    }

    ajusteEl.addEventListener('input', () => {
      let val = parseFloat(ajusteEl.value);
      if (!isNaN(val) && val > 200) {
        ajusteEl.value = 200;
      }
    });

    toggleEl.addEventListener('change', updateField);
    updateField(); // inicializa corretamente
  });
}

// ‚úÖ Chamada da fun√ß√£o no final do script
fixPaletoCalcaAjusteToggle();

// === AG-GRID MOCK ===
const gridDiv = document.getElementById('osGrid');
if (gridDiv) {
  gridDiv.style.height = '500px';
  const columnDefs = [
    { headerName: 'ID', field: 'id', width: 80 },
    { headerName: 'Cliente', field: 'cliente', flex: 1 },
    { headerName: 'Telefone', field: 'telefone', width: 150 },
    { headerName: 'CPF', field: 'cpf', width: 150 },
    { headerName: 'Evento', field: 'evento', flex: 1 },
    { headerName: 'Data Evento', field: 'data_evento', width: 130 },
    { headerName: 'Valor Total', field: 'valor_total', width: 120 },
    { headerName: 'Sinal', field: 'sinal', width: 100 },
    { headerName: 'Restante', field: 'restante', width: 100 },
    { headerName: 'Tipo', field: 'tipo', width: 100 }
  ];

  const rowData = [
    {
      id: 1,
      cliente: 'Jo√£o da Silva',
      telefone: '(11) 91234-5678',
      cpf: '123.456.789-00',
      evento: 'Casamento',
      data_evento: '2025-06-10',
      valor_total: '500.00',
      sinal: '100.00',
      restante: '400.00',
      tipo: 'Loca√ß√£o'
    },
    {
      id: 2,
      cliente: 'Maria Oliveira',
      telefone: '(21) 99888-7777',
      cpf: '987.654.321-00',
      evento: 'Formatura',
      data_evento: '2025-07-15',
      valor_total: '650.00',
      sinal: '200.00',
      restante: '450.00',
      tipo: 'Compra'
    }
  ];

  new agGrid.Grid(gridDiv, {
    columnDefs,
    rowData,
    defaultColDef: {
      resizable: true,
      sortable: true,
      filter: true
    },
    pagination: true,
    paginationPageSize: 10
  });
}



});
</script>
{% endblock %}
