{% extends "base_auth.html" %}
{% load static %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root {
    --primary: #0069d9;
    --light-bg: #f8f9fa;
    --card-bg: #ffffff;
    --border: #dee2e6;
    --text: #212529;
    --danger: #dc3545;
  }
  body {
    background: var(--light-bg);
    color: var(--text);
  }

  /* Layout */
  .d-flex.main { gap: 1rem; }
  .form-container {
    flex-grow: 1;
    max-width: calc(100% - 620px);
    transition: max-width .3s ease;
  }
  .list-mode .form-container {
    max-width: 100% !important;
  }

  .summary-sidebar {
    width: 600px;
    flex-shrink: 0;
    background: var(--card-bg);
    border-left: 2px solid var(--primary);
    padding: 1rem;
    max-height: 90vh;
    overflow-y: auto;
    transition: opacity .3s ease, width .3s ease;
  }
  .list-mode .summary-sidebar {
    opacity: 0;
    width: 0;
    pointer-events: none;
  }

  /* Inputs padding (placeholder spacing) */
  .form-control, .form-select {
    padding: .75rem .75rem;
  }

  /* Stepper */
  .stepper { display: flex; justify-content: space-between; margin: 2rem 0; position: relative; }
  .stepper::before {
    content: ''; position: absolute; top: 50%; left: 2rem; right: 2rem;
    height: 2px; background: var(--border); z-index: 0;
  }
  .step { position: relative; z-index: 1; text-align: center; flex: 1; }
  .step-circle {
    display: inline-block; width: 2.5rem; height: 2.5rem;
    line-height: 2.5rem; border-radius: 50%; border: 2px solid var(--border);
    background: var(--card-bg); transition: .3s;
  }
  .step-label { margin-top: .3rem; font-size: .9rem; display: block; }
  .step.active .step-circle, .step.completed .step-circle {
    background: var(--primary); border-color: var(--primary); color: #fff;
  }
  .step.active .step-label, .step.completed .step-label { color: var(--primary); }

  /* Form Steps */
  .form-step { display: none; animation: fadeIn .3s; }
  .form-step.active { display: block; }
  @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }

  /* Summary */
  .summary-sidebar h5 { color: var(--primary); margin-bottom: 1rem; font-weight: 600; }
  .summary-section { margin-bottom: 1.5rem; display: none; }
  .summary-section h6 {
    margin-bottom: .5rem; font-weight: 600; font-size: 1rem; color: var(--primary);
  }
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: .5rem;
  }
  .summary-item {
    background: var(--light-bg);
    border: 1px solid var(--border);
    border-radius: .25rem;
    padding: .4rem .6rem;
    font-size: .85rem;
  }
  .summary-item .label { font-weight: 600; margin-right: .25rem; }

  /* Toast */
  .toast-body ul { margin: 0; padding-left: 1rem; }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex main">

    <!-- Form -->
    <div class="form-container">
      <div class="card shadow-sm">
        <div class="card-body">

          <!-- Nav -->
          <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
              <button class="nav-link active" data-coreui-toggle="tab" data-coreui-target="#cadastro">
                üìù Cadastrar OS
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-coreui-toggle="tab" data-coreui-target="#listagem">
                üìã Listar OS
              </button>
            </li>
          </ul>

          <div class="tab-content">

            <!-- CADASTRO -->
            <div class="tab-pane fade show active" id="cadastro">

              <!-- Stepper -->
              <div class="stepper">
                <div class="step active" data-step="1"><span class="step-circle">ü§ç</span><span class="step-label">Cliente</span></div>
                <div class="step" data-step="2"><span class="step-circle">üß•</span><span class="step-label">Palet√≥</span></div>
                <div class="step" data-step="3"><span class="step-circle">üëï</span><span class="step-label">Camisa</span></div>
                <div class="step" data-step="4"><span class="step-circle">üëñ</span><span class="step-label">Cal√ßa</span></div>
                <div class="step" data-step="5"><span class="step-circle">üíé</span><span class="step-label">Acess√≥rios</span></div>
                <div class="step" data-step="6"><span class="step-circle">üí∞</span><span class="step-label">Pagamento</span></div>
              </div>

              <form id="osForm" novalidate>
                {% csrf_token %}

                <!-- STEP 1: Cliente -->
                <div class="form-step active" data-step="1">
                  <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">Nome *</label><input name="cliente_nome" type="text" class="form-control" placeholder="Digite o nome" required></div>
                    <div class="col-md-6"><label class="form-label">Telefone *</label><input name="telefone" type="text" class="form-control" placeholder="(__) _____-____" required></div>
                    <div class="col-md-6"><label class="form-label">CPF *</label><input name="cpf" type="text" class="form-control" placeholder="___.___.___-__" required></div>
                    <div class="col-md-6"><label class="form-label">CEP</label><input id="cep" name="cep" type="text" class="form-control" placeholder="_____-___"></div>
                    <div class="col-md-6"><label class="form-label">Rua</label><input id="rua" name="rua" type="text" class="form-control" readonly></div>
                    <div class="col-md-3"><label class="form-label">N√∫mero</label><input id="numero" name="numero" type="text" class="form-control"></div>
                    <div class="col-md-3"><label class="form-label">Bairro</label><input id="bairro" name="bairro" type="text" class="form-control" readonly></div>
                    <div class="col-md-6"><label class="form-label">Cidade</label><input id="cidade" name="cidade" type="text" class="form-control" readonly></div>
                  </div>
                  <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 2: Palet√≥ -->
                <div class="form-step" data-step="2">
                  <div class="row g-3">
                    <div class="col-md-2"><label class="form-label">N¬∫</label><input name="paleto" type="text" class="form-control" placeholder="e.g. 001" required></div>
                    <div class="col-md-2"><label class="form-label">Cor</label><select name="cor_paleto" class="form-select color-select" required></select></div>
                    <div class="col-md-2"><label class="form-label">Mg</label><input name="paleto_mg" type="number" class="form-control" placeholder="e.g. 42" required></div>
                    <div class="col-md-2"><label class="form-label">Ajuste?</label><select name="paleto_ajuste" class="form-select toggle-dependent" data-target=".paleto-ajuste"><option value="">--</option><option value="yes">Sim</option><option value="no">N√£o</option></select></div>
                    <div class="col-md-2 paleto-ajuste dependent-field" style="display:none"><label class="form-label">Ajuste (cm)</label><input name="paleto_ajuste_cm" type="number" step="0.5" class="form-control" placeholder="e.g. 1.5" disabled></div>
                    <div class="col-md-2"><label class="form-label">Extras</label><input name="paleto_ajustes_adicionais" type="text" class="form-control" placeholder="observa√ß√µes"></div>
                  </div>
                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 3: Camisa -->
                <div class="form-step" data-step="3">
                  <div class="row g-3">
                    <div class="col-md-2"><label class="form-label">N¬∫</label><input name="camisa" type="text" class="form-control" placeholder="e.g. 002" required></div>
                    <div class="col-md-2"><label class="form-label">Cor</label><select name="cor_camisa" class="form-select color-select" required></select></div>
                    <div class="col-md-2"><label class="form-label">Mg</label><input name="camisa_mg" type="number" class="form-control" placeholder="e.g. M" required></div>
                    <div class="col-md-2"><label class="form-label">Ajuste?</label><select name="camisa_ajuste" class="form-select toggle-dependent" data-target=".camisa-ajuste"><option value="">--</option><option value="yes">Sim</option><option value="no">N√£o</option></select></div>
                    <div class="col-md-2 camisa-ajuste dependent-field" style="display:none"><label class="form-label">Ajuste (cm)</label><input name="camisa_ajuste_cm" type="number" step="0.5" class="form-control" placeholder="e.g. 0.5" disabled></div>
                    <div class="col-md-2"><label class="form-label">Extras</label><input name="camisa_ajustes_adicionais" type="text" class="form-control" placeholder="observa√ß√µes"></div>
                  </div>
                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 4: Cal√ßa -->
                <div class="form-step" data-step="4">
                  <div class="row g-3">
                    <div class="col-md-2"><label class="form-label">N¬∫</label><input name="calca" type="text" class="form-control" placeholder="e.g. 003" required></div>
                    <div class="col-md-2"><label class="form-label">Cor</label><select name="cor_calca" class="form-select color-select" required></select></div>
                    <div class="col-md-2"><label class="form-label">Cp</label><input name="calca_cp" type="number" class="form-control" placeholder="e.g. 80" required></div>
                    <div class="col-md-2"><label class="form-label">Perna</label><input name="calca_perna" type="number" class="form-control" placeholder="cm" required></div>
                    <div class="col-md-2"><label class="form-label">Ajuste?</label><select name="calca_ajuste" class="form-select toggle-dependent" data-target=".calca-ajuste"><option value="">--</option><option value="yes">Sim</option><option value="no">N√£o</option></select></div>
                    <div class="col-md-2 calca-ajuste dependent-field" style="display:none"><label class="form-label">Ajuste (cm)</label><input name="calca_ajuste_cm" type="number" step="0.5" class="form-control" placeholder="e.g. 2.0" disabled></div>
                    <div class="col-md-4"><label class="form-label">Extras</label><input name="calca_ajustes_adicionais" type="text" class="form-control" placeholder="observa√ß√µes"></div>
                  </div>
                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 5: Acess√≥rios -->
                <div class="form-step" data-step="5">
                  <div class="row g-3">
                    <div class="col-md-2"><label class="form-label">Suspens√≥rio?</label><select name="suspensorio_sim" class="form-select toggle-dependent" data-target=".suspensorio-info"><option value="">--</option><option value="yes">Sim</option><option value="no">N√£o</option></select></div>
                    <div class="col-md-2 suspensorio-info dependent-field" style="display:none"><label class="form-label">Cor</label><select name="suspensorio_cor" class="form-select color-select"></select></div>
                    <div class="col-md-2"><label class="form-label">Len√ßo?</label><select name="lenco_sim" class="form-select toggle-dependent" data-target=".lenco-info"><option value="">--</option><option value="yes">Sim</option><option value="no">N√£o</option></select></div>
                    <div class="col-md-2 lenco-info dependent-field" style="display:none"><label class="form-label">Cor</label><select name="lenco_cor" class="form-select color-select"></select></div>
                    <div class="col-md-2"><label class="form-label">Passante?</label><select name="passante_sim" class="form-select toggle-dependent" data-target=".passante-info"><option value="">--</option><option value="yes">Sim</option><option value="no">N√£o</option></select></div>
                    <div class="col-md-2 passante-info dependent-field" style="display:none"><label class="form-label">Cor</label><select name="passante_cor" class="form-select color-select"></select></div>
                    <div class="col-md-2"><label class="form-label">Sapato?</label><select name="sapato_sim" class="form-select toggle-dependent" data-target=".sapato-info"><option value="">--</option><option value="yes">Sim</option><option value="no">N√£o</option></select></div>
                    <div class="col-md-2 sapato-info dependent-field" style="display:none"><label class="form-label">Tipo</label><input name="sapato_tipo" type="text" class="form-control"></div>
                    <div class="col-md-2 sapato-info dependent-field" style="display:none"><label class="form-label">N¬∫</label><input name="sapato_numero" type="number" class="form-control"></div>
                  </div>
                  <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="button" class="btn btn-primary" data-action="next">Pr√≥ximo</button>
                  </div>
                </div>

                <!-- STEP 6: Pagamento + Salvar -->
                <div class="form-step" data-step="6">
                  <div class="row g-3">
                    <div class="col-md-4"><label class="form-label">Total (R$) *</label><input name="valor_total" type="text" class="form-control" placeholder="0.00" required></div>
                    <div class="col-md-4"><label class="form-label">Sinal (R$) *</label><input name="valor_sinal" type="text" class="form-control" placeholder="0.00" required></div>
                    <div class="col-md-4"><label class="form-label">Restante (R$) *</label><input name="valor_restante" type="text" class="form-control" placeholder="0.00" readonly></div>
                  </div>
                  <div class="d-flex justify-content-between mt-3">   
                    <button type="button" class="btn btn-secondary" data-action="prev">Anterior</button>
                    <button type="submit" class="btn btn-success">Salvar OS</button>
                  </div>
                </div>

              </form>
            </div>

            <!-- LISTAGEM -->
            <div class="tab-pane fade" id="listagem">
              <div class="row g-4">
                {% for os in ordens %}
                  <div class="col-md-4">
                    <div class="card h-100">
                      <div class="card-header">OS #{{ os.id }}</div>
                      <div class="card-body">
                        <p><strong>Cliente:</strong> {{ os.cliente.nome }}</p>
                        <p><strong>Telefone:</strong> {{ os.cliente.telefone }}</p>
                        <p><strong>Status:</strong> {{ os.status }}</p>
                        <hr>
                        <p><strong>Total:</strong> R$ {{ os.valor_total }}</p>
                        <p><strong>Sinal:</strong> R$ {{ os.valor_sinal }}</p>
                        <p><strong>Restante:</strong> R$ {{ os.valor_restante }}</p>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div class="col-12 text-center text-muted">Nenhuma ordem cadastrada.</div>
                {% endfor %}
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Summary Sidebar -->
    <div class="summary-sidebar">
      <h5>üìã Resumo</h5>
      <div id="liveSummary">
        <div class="summary-section" data-section="Cliente">
          <h6>üë§ Cliente</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Itens">
          <h6>üëî Itens</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Acess√≥rios">
          <h6>üíé Acess√≥rios</h6>
          <div class="summary-grid"></div>
        </div>
        <div class="summary-section" data-section="Pagamento">
          <h6>üí∞ Pagamento</h6>
          <div class="summary-grid"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Error Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1100;">
  <div id="errorToast" class="toast align-items-center border border-danger" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body text-danger"></div>
      <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Steps/navigation
  const steps = document.querySelectorAll('.step');
  const forms = document.querySelectorAll('.form-step');
  const form  = document.getElementById('osForm');
  const toast = new bootstrap.Toast(document.getElementById('errorToast'));
  let current = 1;
  function showStep(n) {
    forms.forEach(f => f.classList.toggle('active', +f.dataset.step === n));
    steps.forEach(s => {
      const idx = +s.dataset.step;
      s.classList.toggle('active', idx === n);
      s.classList.toggle('completed', idx < n);
    });
    current = n;
  }
  document.querySelectorAll('[data-action=next]').forEach(btn =>
    btn.addEventListener('click', () => { if (current < forms.length) showStep(current + 1); })
  );
  document.querySelectorAll('[data-action=prev]').forEach(btn =>
    btn.addEventListener('click', () => { if (current > 1) showStep(current - 1); })
  );
  form.addEventListener('keydown', e => {
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
  });
  document.querySelectorAll('[data-coreui-toggle="tab"]').forEach(link =>
    link.addEventListener('click', () => {
      document.body.classList.toggle('list-mode', link.getAttribute('data-coreui-target') === '#listagem');
    })
  );

  // Summary wiring
  ['input','change'].forEach(evt => form.addEventListener(evt, updateSummary));

  // --- Masks & Validations ---

  // Telefone
  const telEl = form.querySelector('input[name="telefone"]');
  telEl.addEventListener('input', () => {
    let v = telEl.value.replace(/\D/g, '').slice(0,11);
    if (v.length > 2) {
      const d = v.slice(0,2), n = v.slice(2);
      if (n.length > 8) v = `(${d}) ${n.slice(0,5)}-${n.slice(5)}`;
      else if (n.length > 4) v = `(${d}) ${n.slice(0,4)}-${n.slice(4)}`;
      else v = `(${d}) ${n}`;
    }
    telEl.value = v;
  });

  // CPF
  const cpfEl = form.querySelector('input[name="cpf"]');
  cpfEl.addEventListener('input', () => {
    let v = cpfEl.value.replace(/\D/g, '').slice(0,11);
    if (v.length > 9) v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
    else if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
    else if (v.length > 3) v = v.replace(/(\d{3})(\d{0,3})/, '$1.$2');
    cpfEl.value = v;
  });

  // CEP + ViaCEP
  const cepEl = document.getElementById('cep');
  cepEl.addEventListener('input', () => {
    let v = cepEl.value.replace(/\D/g, '').slice(0,8);
    if (v.length > 5) v = v.replace(/(\d{5})(\d{0,3})/, '$1-$2');
    cepEl.value = v;
  });
  ['blur','input'].forEach(evt => cepEl.addEventListener(evt, async () => {
    const v = cepEl.value.replace(/\D/g,'');
    if (v.length === 8) {
      try {
        const res = await fetch(`https://viacep.com.br/ws/${v}/json/`);
        const data = await res.json();
        if (!data.erro) {
          ['logradouro','bairro','localidade'].forEach((f,i) => {
            ['rua','bairro','cidade'][i] && (document.getElementById(['rua','bairro','cidade'][i]).value = data[f]);
          });
        }
      } catch {}
    } else if (!v) {
      ['rua','bairro','cidade'].forEach(id => document.getElementById(id).value = '');
    }
    updateSummary();
  }));

  // Numeric clamp ‚â§200 for base fields
  ['paleto_mg','camisa_mg','calca_cp','calca_perna','numero'].forEach(name => {
    const el = form.querySelector(`[name="${name}"]`);
    if (!el) return;
    el.addEventListener('input', () => {
      const n = parseFloat(el.value);
      if (!isNaN(n)) {
        if (n > 200) el.value = 200;
        else if (n < 0) el.value = '';
      }
    });
  });

  // Ajuste logic: only enable when base exists & < base
  [
    { adj: 'paleto_ajuste_cm', base: 'paleto_mg', toggle: 'paleto_ajuste', step: 0.5 },
    { adj: 'camisa_ajuste_cm', base: 'camisa_mg', toggle: 'camisa_ajuste', step: 0.5 },
    { adj: 'calca_ajuste_cm',  base: 'calca_perna', toggle: 'calca_ajuste',  step: 0.5 },
  ].forEach(({adj, base, toggle, step}) => {
    const adjEl    = form.querySelector(`[name="${adj}"]`);
    const baseEl   = form.querySelector(`[name="${base}"]`);
    const toggleEl = form.querySelector(`[name="${toggle}"]`);
    const wrapper  = adjEl.closest('.dependent-field');

    function updateAdjustVisibility() {
      const bv = parseFloat(baseEl.value);
      if (toggleEl.value === 'yes' && !isNaN(bv)) {
        wrapper.style.display = 'block';
        adjEl.disabled = false;
        adjEl.setAttribute('max', bv - step);
      } else {
        wrapper.style.display = 'none';
        adjEl.value = '';
        adjEl.disabled = true;
      }
    }

    toggleEl.addEventListener('change', updateAdjustVisibility);
    baseEl.addEventListener('input', updateAdjustVisibility);

    adjEl.addEventListener('input', () => {
      const av = parseFloat(adjEl.value);
      const max = parseFloat(adjEl.max);
      if (!isNaN(av) && !isNaN(max) && av >= max) {
        adjEl.value = max;
      }
    });

    // init
    updateAdjustVisibility();
  });

  // Payment logic
  const totalEl = form.querySelector('input[name="valor_total"]');
  const sinalEl = form.querySelector('input[name="valor_sinal"]');
  const restEl  = form.querySelector('input[name="valor_restante"]');
  restEl.setAttribute('readonly','readonly');

  function fmtDec(el) {
    let parts = el.value.replace(/[^0-9\.]/g,'').split('.');
    if (parts.length > 2) parts = [parts[0], parts.slice(1).join('')];
    el.value = parts[0] + (parts[1] ? '.' + parts[1].slice(0,2) : '');
  }

  // on total input: format + recalc rest
  totalEl.addEventListener('input', () => {
    fmtDec(totalEl);
    const t = parseFloat(totalEl.value);
    const s = parseFloat(sinalEl.value);
    if (!isNaN(t)) {
      if (isNaN(s)) restEl.value = t.toFixed(2);
      else restEl.value = (t - s).toFixed(2);
    } else {
      restEl.value = '';
    }
  });
  // on sinal input: format + recalc rest fluidly
  sinalEl.addEventListener('input', () => {
    fmtDec(sinalEl);
    const t = parseFloat(totalEl.value);
    const s = parseFloat(sinalEl.value);
    if (!isNaN(t)) {
      if (isNaN(s)) restEl.value = t.toFixed(2);
      else restEl.value = (t - s).toFixed(2);
    } else {
      restEl.value = '';
    }
  });
  // on blur: enforce clamp sinal ‚â§ total
  [totalEl, sinalEl].forEach(el => {
    el.addEventListener('blur', () => {
      const t = parseFloat(totalEl.value);
      let s = parseFloat(sinalEl.value);
      if (!isNaN(t)) {
        if (isNaN(s) || s < 0) s = 0;
        if (s > t) s = t;
        sinalEl.value = s.toFixed(2);
        restEl.value  = (t - s).toFixed(2);
      }
    });
  });

  // Load colors
  fetch("{% url 'list_colors' %}")
    .then(r => r.json())
    .then(colors => {
      document.querySelectorAll('.color-select').forEach(sel => {
        sel.innerHTML = '<option value="">--</option>' +
          colors.map(c => `<option value="${c.id}">${c.description}</option>`).join('');
      });
    });

  // Toggle dependent fields (other accessories)
  document.querySelectorAll('.toggle-dependent').forEach(sel => sel.addEventListener('change', () => {
    document.querySelectorAll(sel.dataset.target).forEach(el => {
      el.style.display = sel.value === 'yes' ? 'block' : 'none';
    });
    updateSummary();
  }));

  // Build summary
  const itemGroups = [
    ['Palet√≥', [
      ['paleto','N¬∫'],['cor_paleto','Cor'],['paleto_mg','Mg'],
      ['paleto_ajuste_cm','Ajuste', f=>f.get('paleto_ajuste')==='yes'],
      ['paleto_ajustes_adicionais','Extras']
    ]],
    ['Camisa', [
      ['camisa','N¬∫'],['cor_camisa','Cor'],['camisa_mg','Mg'],
      ['camisa_ajuste_cm','Ajuste', f=>f.get('camisa_ajuste')==='yes'],
      ['camisa_ajustes_adicionais','Extras']
    ]],
    ['Cal√ßa', [
      ['calca','N¬∫'],['cor_calca','Cor'],['calca_cp','Cp'],['calca_perna','Perna'],
      ['calca_ajuste_cm','Ajuste', f=>f.get('calca_ajuste')==='yes'],
      ['calca_ajustes_adicionais','Extras']
    ]]
  ];
  const schema = {
    'Cliente': [
      ['cliente_nome','Nome'],['telefone','Telefone'],['cpf','CPF'],
      ['rua','Rua'],['numero','N√∫mero'],['bairro','Bairro'],['cidade','Cidade']
    ],
    'Acess√≥rios': [
      ['suspensorio_sim','Suspens√≥rio'],['suspensorio_cor','Cor', f=>f.get('suspensorio_sim')==='yes'],
      ['lenco_sim','Len√ßo'],['lenco_cor','Cor', f=>f.get('lenco_sim')==='yes'],
      ['passante_sim','Passante'],['passante_cor','Cor', f=>f.get('passante_sim')==='yes'],
      ['sapato_sim','Sapato'],['sapato_tipo','Tipo', f=>f.get('sapato_sim')==='yes'],
      ['sapato_numero','N¬∫', f=>f.get('sapato_sim')==='yes']
    ],
    'Pagamento': [
      ['valor_total','Total'],['valor_sinal','Sinal'],['valor_restante','Restante']
    ]
  };
  function updateSummary() {
    const fd = new FormData(form);
    ['Cliente','Itens','Acess√≥rios','Pagamento'].forEach(section => {
      const secEl = document.querySelector(`.summary-section[data-section="${section}"]`);
      const grid  = secEl.querySelector('.summary-grid');
      grid.innerHTML = '';
      if (section==='Itens') {
        itemGroups.forEach(([title, fields]) => {
          const parts = [];
          fields.forEach(([k,label,cond]) => {
            if ((!cond||cond(fd)) && fd.get(k)) {
              let v = fd.get(k);
              const el = form.querySelector(`[name="${k}"]`);
              if (el && el.tagName==='SELECT') v = el.options[el.selectedIndex]?.text||v;
              parts.push(`<span class="label">${label}:</span>${v}`);
            }
          });
          if (parts.length) {
            const div = document.createElement('div');
            div.className = 'summary-item';
            div.innerHTML = `<strong>${title}:</strong> `+parts.join(' | ');
            grid.appendChild(div);
          }
        });
      } else {
        schema[section].forEach(([k,label,cond]) => {
          if ((!cond||cond(fd)) && fd.get(k)) {
            const div = document.createElement('div');
            div.className = 'summary-item';
            if (k.endsWith('_sim')) {
              if (fd.get(k)==='yes') div.innerHTML = `<span class="label">${label}</span>‚úÖ`;
            } else {
              let v = fd.get(k);
              const el = form.querySelector(`[name="${k}"]`);
              if (el && el.tagName==='SELECT') v = el.options[el.selectedIndex]?.text||v;
              div.innerHTML = `<span class="label">${label}:</span>${v}`;
            }
            grid.appendChild(div);
          }
        });
      }
      secEl.style.display = grid.children.length ? 'block' : 'none';
    });
  }

  // Validate & submit
  form.addEventListener('submit', e => {
    e.preventDefault();
    const missing = [];
    ['Cliente','Itens','Acess√≥rios','Pagamento'].forEach(section => {
      if (section==='Itens') {
        itemGroups.forEach(([title,fields]) => {
          const [k] = fields[0];
          if (!form.querySelector(`[name="${k}"]`).value) missing.push(title);
        });
      } else {
        schema[section].forEach(([k,label,cond]) => {
          if ((!cond||cond(new FormData(form))) && !form.querySelector(`[name="${k}"]`).value) {
            missing.push(label);
          }
        });
      }
    });
    if (missing.length) {
      const body = document.getElementById('errorToast').querySelector('.toast-body');
      const uniq = [...new Set(missing)];
      body.innerHTML = '<strong>Campos faltando:</strong><ul>' + uniq.map(l=>`<li>${l}</li>`).join('') + '</ul>';
      toast.show();
    } else {
      form.submit();
    }
  });

  // Initialize
  showStep(1);
  updateSummary();
});
</script>
{% endblock %}
